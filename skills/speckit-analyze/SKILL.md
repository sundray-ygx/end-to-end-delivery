---
name: speckit-analyze
description: Speckit 一致性分析 - 六重检测（重复/歧义/欠规格/宪法/覆盖/一致）
---

# Speckit 一致性分析

## 概述

本技能实现 Speckit 框架的六重一致性分析功能，对规格文档、技术计划和任务列表进行全面的质量检查，确保需求的一致性、完整性和可追溯性。

**核心功能**:
- **重复检测** - 识别相似或重复的需求
- **歧义检测** - 标记模糊和不明确的描述
- **欠规格检测** - 发现缺失的验收标准
- **宪法对齐** - 验证与项目宪法的合规性
- **覆盖率分析** - 检查需求到任务的映射完整性
- **不一致性检查** - 发现术语冲突和需求矛盾

## 使用方式

### 基本用法

```text
/skill speckit-analyze
```

### 指定分析范围

```text
/skill speckit-analyze --spec-only
/skill speckit-analyze --include-tasks
```

### 在工作流中调用

```text
# 在 Plan 阶段后调用
/plan "技术方案"
→ 调用 speckit-analyze 验证一致性
```

## 六重分析检测

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         六重一致性分析检测                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. 重复检测 (Duplication)                                                  │
│     ├─ 识别相似需求                                                         │
│     ├─ 检测重复描述                                                         │
│     └─ 标记冗余内容                                                         │
│                                                                             │
│  2. 歧义检测 (Ambiguity)                                                    │
│     ├─ 模糊形容词: fast, scalable, secure                                  │
│     ├─ 未量化指标                                                          │
│     ├─ 占位符: TODO, TKTK, ???                                             │
│     └─ [NEEDS CLARIFICATION] 标记                                          │
│                                                                             │
│  3. 欠规格检测 (Underspecification)                                        │
│     ├─ 缺失验收标准                                                         │
│     ├─ 用户故事无接受条件                                                   │
│     ├─ 缺少边缘情况                                                         │
│     └─ 成功标准非技术无关                                                   │
│                                                                             │
│  4. 宪法对齐 (Constitution)                                                │
│     ├─ MUST 原则冲突                                                       │
│     ├─ 缺失必需章节                                                         │
│     ├─ TDD 合规性                                                          │
│     └─ 价值优先原则                                                        │
│                                                                             │
│  5. 覆盖率缺口 (Coverage Gaps)                                             │
│     ├─ 需求无用户故事覆盖                                                   │
│     ├─ 用户故事无接受条件                                                   │
│     ├─ 缺失成功标准                                                         │
│     └─ 非功能需求未处理                                                     │
│                                                                             │
│  6. 不一致性检查 (Inconsistency)                                           │
│     ├─ 术语漂移（同一概念不同命名）                                         │
│     ├─ 需求冲突                                                           │
│     ├─ 优先级错配                                                          │
│     └─ 用户故事依赖破坏独立性                                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 严重程度分级

| 级别 | 描述 | 示例 | 处理 |
|------|------|------|------|
| **CRITICAL** | 违反宪法 MUST、缺失核心章节、阻塞价值交付 | 无 TDD 方法、缺失成功标准 | 必须修复后继续 |
| **HIGH** | 重复/冲突需求、模糊安全/性能、缺失验收标准 | "快速响应"无指标、安全需求模糊 | 强烈建议修复 |
| **MEDIUM** | 术语漂移、缺失边缘情况、非功能需求欠规格 | 缺少错误处理、无零状态 | 建议修复 |
| **LOW** | 措辞改进、轻微冗余、样式问题 | 描述冗长、轻微重复 | 可选修复 |

## 输入输出

### 输入

自动检测并加载：
- `spec.md` - 功能规格
- `plan.md` - 技术计划（如存在）
- `tasks.md` - 任务列表（如存在）
- `constitution.md` - 项目宪法（如存在）

### 输出

分析报告包含：

```markdown
# 规格分析报告

## 执行摘要
[高层次分析结果摘要]

## 发现

| ID | 类别 | 严重程度 | 位置 | 摘要 | 建议 |
|----|------|----------|------|------|------|
| A1 | 歧义 | HIGH | spec.md:L45 | "快速响应"缺乏指标 | 指定可测量目标（如"<200ms p95"） |
| C1 | 宪法 | CRITICAL | spec.md:L80 | 未提及 TDD 方法 | 添加 TDD 需求到实施方法 |

## 覆盖率分析

### 用户故事覆盖率

| 故事 | 优先级 | 验收标准 | 独立测试 | 备注 |
|------|--------|----------|----------|------|
| US1 | P1 | ✓ | ✓ | MVP 候选 |
| US2 | P2 | ✗ | ✓ | 缺失验收场景 |

### 需求覆盖率

| 类别 | 数量 | 已覆盖 | 覆盖率 % |
|------|------|--------|----------|
| 功能性 | 8 | 7 | 87.5% |
| 非功能性 | 3 | 1 | 33.3% |

## 宪法合规性

| 原则 | 状态 | 备注 |
|------|------|------|
| 价值优先 | ⚠️ 警告 | US2 缺乏清晰价值主张 |
| TDD | ✓ 通过 | 测试方法已定义 |
| 规格质量 | ✗ 失败 | 发现 2 个模糊需求 |

## 指标

- 总需求数: X
- 总用户故事数: Y
- 覆盖率: Z%
- 歧义数量: A
- 重复数量: D
- 关键问题数: C

## 下一步行动
[具体的继续处理建议]
```

## 检测详情

### 1. 重复检测

**检测方法**:
- 语义相似度分析
- 关键词匹配
- 结构模式比较

**报告格式**:
```markdown
| D1 | 重复 | MEDIUM | spec.md:L20, L25 | 两处描述相同功能 | 合并为单一需求 |
```

### 2. 歧义检测

**模糊词汇列表**:
- fast, slow, quick, rapid
- scalable, performant, efficient
- secure, safe, robust
- intuitive, user-friendly, easy
- flexible, modular, maintainable

**检测规则**:
- 模糊形容词 + 无量化指标 = HIGH
- 占位符 (TODO, ???) = MEDIUM
- [NEEDS CLARIFICATION] = CRITICAL

**报告格式**:
```markdown
| A1 | 歧义 | HIGH | spec.md:L45 | "快速加载"无具体时间 | 指定目标（如"<2s p95"） |
```

### 3. 欠规格检测

**检查项**:
- [ ] 功能需求有验收标准
- [ ] 用户故事有接受条件
- [ ] 定义了边缘情况
- [ ] 成功标准可测量
- [ ] 成功标准技术无关

**报告格式**:
```markdown
| U1 | 欠规格 | HIGH | spec.md:L60 | 缺失败密码处理 | 添加错误场景需求 |
```

### 4. 宪法对齐

**检查项目宪法的 MUST 原则**:
- TDD 强制执行
- 价值优先开发
- 规格质量标准
- 质量门禁

**报告格式**:
```markdown
| C1 | 宪法 | CRITICAL | spec.md | 无 TDD 方法描述 | 添加测试驱动方法 |
```

### 5. 覆盖率分析

**覆盖率计算**:
```
需求覆盖率 = 有用户故事覆盖的需求 / 总需求数
用户故事覆盖率 = 有验收标准的故事 / 总故事数
```

**报告格式**:
```markdown
| G1 | 覆盖率 | MEDIUM | spec.md | 非功能需求 33% 覆盖 | 添加性能/安全需求 |
```

### 6. 不一致性检查

**检查项**:
- 同一概念使用不同术语
- 需求之间相互冲突
- 优先级标记不合理
- 用户故事有隐式依赖

**报告格式**:
```markdown
| I1 | 不一致 | MEDIUM | spec.md:L30, L80 | "用户"与"客户"混用 | 统一术语 |
```

## 使用场景

### 场景 1: Plan 阶段后验证

```text
/skill speckit-workflow "实现用户登录"
→ Specify 完成
→ Plan 完成
→ 调用 speckit-analyze 验证
→ 根据 CRITICAL/HIGH 问题修复
→ 继续 Tasks 阶段
```

### 场景 2: Verify 阶段前检查

```text
# E2D Verify 阶段
/verify
→ 调用 speckit-analyze 检查一致性
→ 根据 CRITICAL 问题决定是否继续
```

### 场景 3: 独立质量检查

```text
/skill speckit-analyze

# 对当前功能目录执行分析
# 生成详细报告
```

## 质量门禁

分析完成后，根据结果决定是否继续：

| 结果 | CRITICAL | HIGH | MEDIUM | LOW | 决策 |
|------|----------|------|--------|-----|------|
| 通过 | 0 | 0-1 | ≤5 | 任意 | ✅ 继续 |
| 警告 | 0 | 2-3 | 6-10 | 任意 | ⚠️ 用户决定 |
| 失败 | ≥1 | ≥4 | ≥11 | 任意 | ❌ 修复后重试 |

## 相关技能

- `speckit-workflow` - 完整工作流（Analyze 阶段调用）
- `speckit-guard` - 宪法检查（宪法对齐前置）
- `speckit-tasks` - 任务管理（覆盖率分析前置）

## 配置

### 自定义规则

可在项目根目录创建 `.speckit-analyze-config.json`:

```json
{
  "ambiguity": {
    "additionalWords": ["responsive", "modern"],
    "severity": "MEDIUM"
  },
  "coverage": {
    "minimumThreshold": 0.85
  }
}
```

## 限制

1. **只读分析**: 不修改任何文件
2. **语言支持**: 主要针对中文和英文
3. **上下文**: 需要有 spec.md 文件

## 最佳实践

1. **早期运行**: 在 Plan 阶段后立即运行
2. **迭代修复**: 根据 CRITICAL → HIGH → MEDIUM 顺序修复
3. **跟踪趋势**: 记录分析结果，观察质量改进
