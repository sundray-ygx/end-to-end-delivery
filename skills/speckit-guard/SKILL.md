---
name: speckit-guard
description: Speckit 宪法治理 - 质量门禁、复杂度论证、合规性验证
---

# Speckit 宪法治理

## 概述

本技能实现 Speckit 框架的宪法治理系统，确保所有开发决策符合项目宪法的非可协商原则，通过质量门禁控制开发质量。

**核心功能**:
- **宪法检查** - 验证 MUST 原则合规性
- **质量门禁** - 强制性质量标准验证
- **复杂度论证** - 违规决策的合理性记录
- **模板同步** - 宪法更新时自动同步相关模板

## 使用方式

### 基本用法

```text
/skill speckit-guard
```

### 指定检查范围

```text
/skill speckit-guard --design-stage
/skill speckit-guard --constitution-only
```

### 在工作流中调用

```text
# Design 阶段
/design "技术方案"
→ 调用 speckit-guard 检查宪法合规
→ 根据结果决定是否继续
```

## 宪法结构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         项目宪法治理体系                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  I. Value-First Development (价值优先)                                      │
│     ├─ 用户场景按业务价值排序 (P1, P2, P3...)                               │
│     ├─ 每个用户故事独立可测试和可交付                                        │
│     ├─ MVP 是第一个用户故事 (P1)                                            │
│     └─ 成功标准可测量且技术无关                                             │
│                                                                             │
│  II. Test-Driven Development (测试驱动 - 非可协商)                           │
│     ├─ TDD 强制执行: 测试先写 → 用户审批 → 测试失败 → 然后实现              │
│     ├─ Red-Green-Refactor 循环严格执行                                      │
│     └─ 无例外: 测试不是可选，而是完成的定义                                  │
│                                                                             │
│  III. Specification Quality (规格质量)                                      │
│     ├─ 所有功能必须有完整规格才能规划                                       │
│     ├─ 规格中无实现细节                                                     │
│     ├─ 所有需求可测试且无歧义                                               │
│     ├─ 最多 3 个 [NEEDS CLARIFICATION] 标记                                │
│     └─ 成功标准可测量且无需实现知识                                          │
│                                                                             │
│  IV. Consistency & Quality Gates (一致性与质量门禁)                          │
│     ├─ 所有工件必须通过一致性分析                                           │
│     ├─ 无重复或冲突需求                                                     │
│     ├─ 所有需求有任务覆盖                                                   │
│     ├─ 宪法冲突为 CRITICAL 必须解决                                         │
│     └─ 覆盖率缺口在实现前识别                                               │
│                                                                             │
│  V. Continuous Learning (持续学习)                                         │
│     ├─ Observer Agent 捕获模式和 Instincts                                  │
│     ├─ Instincts 演化为 Skills, Commands, Agents                            │
│     ├─ 跨会话保留知识                                                       │
│     └─ 自动传播最佳实践                                                     │
│                                                                             │
│  VI. Diagnostic Excellence (诊断卓越)                                       │
│     ├─ 五类诊断: build, runtime, performance, security, database            │
│     ├─ 自动化分析和修复建议                                                 │
│     ├─ 与验证阶段集成                                                      │
│     └─ 黑盒 + 白盒测试覆盖                                                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 质量门禁

### Gate 1: 规格质量

- [ ] 无 [NEEDS CLARIFICATION] 标记
- [ ] 所有需求可测试
- [ ] 成功标准可测量
- [ ] 成功标准技术无关
- [ ] 用户场景独立可测试

### Gate 2: 一致性分析

- [ ] 无重复或冲突需求
- [ ] 所有需求有任务覆盖
- [ ] 无宪法违规
- [ ] 术语一致

### Gate 3: 宪法检查

- [ ] TDD 合规验证
- [ ] 价值优先原则遵循
- [ ] 规格质量标准满足
- [ ] 复杂度已论证（如有违规）

### Gate 4: 实施验证

- [ ] 所有测试通过（白盒 + 黑盒）
- [ ] 代码审查完成
- [ ] 安全审查通过
- [ ] 性能基准满足

## 输入输出

### 输入

自动检测并加载：
- `spec.md` - 功能规格
- `plan.md` - 技术计划
- `.claude/constitution/constitution.md` - 项目宪法

### 输出

宪法检查报告：

```markdown
# 宪法检查报告

## 检查概要

**功能**: [FEATURE_NAME]
**日期**: [DATE]
**检查者**: speckit-guard

## 合规状态

| 原则 | 状态 | 备注 |
|------|------|------|
| 价值优先 | ⚠️ 警告 | US2 缺乏清晰价值主张 |
| TDD | ✓ 通过 | 测试方法已定义 |
| 规格质量 | ✗ 失败 | 发现 2 个模糊需求 |
| 一致性 | ✓ 通过 | 无冲突 |
| 持续学习 | ✓ 通过 | Instinct 捕获启用 |
| 诊断卓越 | ✓ 通过 | 五类诊断已配置 |

## 质量门禁

### Gate 1: 规格质量
- [ ] 无 [NEEDS CLARIFICATION] 标记
- [x] 所有需求可测试
- [x] 成功标准可测量
- [ ] 成功标准技术无关
- [x] 用户场景独立可测试

**状态**: ⚠️ 警告 - 2 项未通过

### Gate 2: 一致性分析
- [x] 无重复或冲突需求
- [x] 所有需求有任务覆盖
- [x] 无宪法违规
- [x] 术语一致

**状态**: ✓ 通过

### Gate 3: 宪法检查
- [x] TDD 合规验证
- [x] 价值优先原则遵循
- [ ] 规格质量标准满足
- [x] 复杂度已论证

**状态**: ⚠️ 警告 - 1 项未通过

## 复杂度跟踪

| 违规 | 论证 | 状态 |
|------|------|------|
| 规格包含实现细节 | 由于需要明确数据库选型，在规格中提及 PostgreSQL | 已记录 |

## 决策

**整体状态**: ⚠️ 警告

**建议**:
1. 修复规格质量问题（移除实现细节）
2. 确保成功标准技术无关
3. 重新检查后继续

## 下一步

- 修复问题后: 重新运行 `/skill speckit-guard`
- 继续开发: 通过所有门禁后继续 Tasks 阶段
```

## 复杂度论证

当需要违反宪法原则时，必须在复杂度跟踪表中记录论证：

```markdown
## 复杂度跟踪

| 原则 | 违规描述 | 论证 | 负责人 | 日期 |
|------|----------|------|--------|------|
| 简单优先 | 引入额外抽象层 | 为了支持未来多数据库扩展，引入 Repository 模式 | @user | 2025-02-07 |
| 规格质量 | 规格包含技术细节 | 需要明确安全合规要求，提及 OAuth2 | @user | 2025-02-07 |
```

**论证要求**:
- 必须说明为什么需要违规
- 必须说明带来的价值
- 必须记录决策人和日期

## 使用场景

### 场景 1: Design 阶段检查

```text
/design "技术方案"
→ 调用 speckit-guard 检查宪法合规
→ 根据结果决定是否继续
```

### 场景 2: Plan 完成后验证

```text
/skill speckit-workflow "实现功能"
→ Specify 完成
→ Plan 完成
→ 调用 speckit-guard 验证
→ CRITICAL 违规必须修复
→ 继续 Tasks 阶段
```

### 场景 3: 独立合规检查

```text
/skill speckit-guard

# 对当前功能目录执行宪法检查
# 生成合规报告
```

## 质量门禁决策

| 门禁状态 | Gate 1 | Gate 2 | Gate 3 | Gate 4 | 决策 |
|----------|--------|--------|--------|--------|------|
| 通过 | ✓ | ✓ | ✓ | - | ✅ 继续下一阶段 |
| 警告 | 1-2 项失败 | ✓ | 1 项失败 | - | ⚠️ 用户决定 |
| 失败 | ≥3 项失败 | ✗ | ≥2 项失败 | - | ❌ 修复后重试 |

## 宪法管理

### 创建宪法

```text
/skill speckit-guard --create-constitution
```

生成项目宪法模板到 `.claude/constitution/constitution.md`

### 更新宪法

编辑 `.claude/constitution/constitution.md`:
1. 修改原则描述
2. 更新版本号 (MAJOR.MINOR.PATCH)
3. 记录修改日期和理由
4. 同步相关模板

### 模板同步

当宪法更新时，自动检查并更新：
- `.specify/templates/spec-template.md`
- `.specify/templates/plan-template.md`
- `.specify/templates/tasks-template.md`

## 相关技能

- `speckit-workflow` - 完整工作流（Design 阶段调用）
- `speckit-analyze` - 一致性分析（检查前执行）

## 配置

### 宪法位置

默认: `.claude/constitution/constitution.md`

可通过环境变量自定义:
```bash
export SPECKIT_CONSTITUTION=path/to/constitution.md
```

### 自定义原则

在宪法文件中添加自定义原则：

```markdown
### VII. Custom Principle

[描述]

**MUST**:
- [ ] 必须项 1
- [ ] 必须项 2

**SHOULD**:
- [ ] 建议项 1
```

## 限制

1. **宪法权威**: 宪法原则优先于其他实践和模板
2. **修正流程**: 宪法修正需要文档化、审批、迁移计划
3. **强制执行**: 所有 PR/审查必须验证合规

## 最佳实践

1. **早期检查**: 在 Design 阶段早期执行检查
2. **迭代修复**: 根据 CRITICAL → HIGH → MEDIUM 顺序修复
3. **记录论证**: 所有违规必须记录在复杂度跟踪表
4. **定期审查**: 每季度审查宪法是否需要更新
