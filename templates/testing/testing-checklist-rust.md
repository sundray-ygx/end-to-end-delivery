# Rust 单元测试 Checklist

> 本文档提供 Rust 单元测试的审查维度框架
> 基于内置测试框架、属性测试等最佳实践

## 审查维度说明

本文档不是简单的检查表，而是提供**测试代码的审查维度和框架**。基于这些维度对测试进行深度分析，识别问题和改进空间。

---

## 维度 1: 测试结构

### 1.1 测试组织

**维度说明**: 测试是否正确组织

**审查要点**:
- [ ] 单元测试是否在 src 目录的模块中
- [ ] 集成测试是否在 tests 目录
- [ ] 文档测试是否在文档注释中

---

### 1.2 测试命名规范

**维度说明**: 测试函数命名是否清晰

**审查要点**:
- [ ] 测试名称是否描述性
- [ ] 测试名称是否能表达测试意图

---

## 维度 2: 测试覆盖

### 2.1 快乐路径覆盖

**维度说明**: 正常场景是否都有测试覆盖

**审查要点**:
- [ ] 主要功能路径是否都有测试
- [ ] 公共 API 是否被测试
- [ ] 核心业务逻辑是否被测试

---

### 2.2 边界条件测试

**维度说明**: 边界值、空值等特殊场景是否测试

**审查要点**:
- [ ] Option::None 处理是否测试
- [ ] Result::Err 处理是否测试
- [ ] 空切片/向量是否测试
- [ ] 边界值是否测试

---

### 2.3 错误场景覆盖

**维度说明**: 错误返回是否被测试

**审查要点**:
- [ ] Result::Err 是否被测试
- [ ] panic! 场景是否被测试
- [ ] Option::None 是否被测试
- [ ] 错误类型是否被验证

---

## 维度 3: 断言使用

### 3.1 宏使用

**维度说明**: 是否使用正确的断言宏

**审查要点**:
- [ ] 是否使用 assert_eq! 比较值
- [ ] 是否使用 assert_ne! 验证不等
- [ ] 是否使用 assert! 验证布尔条件
- [ ] 自定义消息是否提供

---

### 3.2 调试断言

**维度说明**: debug 断言是否正确使用

**审查要点**:
- [ ] 是否使用 debug_assert_eq!
- [ ] 是否使用 debug_assert!
- [ ] 是否理解 debug 断言仅在调试构建生效

---

## 维度 4: 属性测试

### 4.1 Proptest 使用

**维度说明**: 关键代码是否有属性测试

**审查要点**:
- [ ] 是否使用 proptest 生成测试输入
- [ ] 是否测试不变量（invariants）
- [ ] 是否测试边界性质
- [ ] 策略（Strategy）是否合理

---

### 4.2 属性质量

**维度说明**: 属性测试是否有效

**审查要点**:
- [ ] 属性是否有意义
- [ ] 是否有足够的测试用例
- [ ] 失败时是否提供有用的信息

---

## 维度 5: 测试隔离

### 5.1 测试独立性

**维度说明**: 测试之间是否相互独立

**审查要点**:
- [ ] 测试执行顺序是否影响结果
- [ ] 是否避免共享状态
- [ ] 每个测试是否清理自己的状态

---

### 5.2 文件系统隔离

**维度说明**: 文件操作是否正确隔离

**审查要点**:
- [ ] 是否使用临时目录
- [ ] 测试后是否清理临时文件
- [ ] 是否避免使用真实文件系统

---

## 维度 6: Mock 和隔离

### 6.1 Trait Mock

**维度说明**: 是否通过 trait 实现 mock

**审查要点**:
- [ ] 依赖是否定义为 trait
- [ ] 是否为测试实现 mock 类型
- [ ] Mock 实现是否在测试模块中

---

### 6.2 Mock 库使用

**维度说明**: 是否使用 mock 库（如 mockall）

**审查要点**:
- [ ] 是否使用 mockall 自动生成 mock
- [ ] Mock 期望是否正确设置
- [ ] Mock 调用是否被验证

---

## 维度 7: 并发测试

### 7.1 并发安全测试

**维度说明**: 并发代码是否有相应测试

**审查要点**:
- [ ] 是否使用多个线程测试
- [ ] 是否测试数据竞争
- [ ] 是否使用 Thread::sleep 暴露竞态

---

### 7.2 通道测试

**维度说明**: 通道操作是否被测试

**审查要点**:
- [ ] 发送/接收是否被测试
- [ ] 通道关闭是否被测试
- [ ] 死锁场景是否被测试

---

### 7.3 同步原语测试

**维度说明**: Mutex、RwLock 等是否被测试

**审查要点**:
- [ ] Mutex 锁竞争是否被测试
- [ ] RwLock 读写是否被测试
- [ ] Condvar 使用是否被测试

---

## 维度 8: 测试覆盖率

### 8.1 覆盖率目标

**维度说明**: 测试覆盖率是否达到 80% 以上

**审查要点**:
- [ ] 是否使用 tarpaulin 或 cargo-llvm-cov
- [ ] 语句覆盖率是否 ≥ 80%
- [ ] 分支覆盖率是否 ≥ 80%

---

### 8.2 覆盖率配置

**维度说明**: 覆盖率工具是否正确配置

**审查要点**:
- [ ] .cargo/config.toml 是否配置
- [ ] 覆盖率排除是否合理
- [ ] CI 中是否生成覆盖率报告

---

## 维度 9: 文档测试

### 9.1 文档示例

**维度说明**: 公共 API 是否有文档测试

**审查要点**:
- [ ] 公共函数是否有文档示例
- [ ] 示例是否完整可运行
- [ ] 文档测试是否通过 cargo test

---

### 9.2 文档质量

**维度说明**: 文档示例是否有质量

**审查要点**:
- [ ] 示例是否展示真实用法
- [ ] 示例是否简洁清晰
- [ ] 是否有边界情况示例

---

## 维度 10: 基准测试

### 10.1 Criterion 使用

**维度说明**: 性能关键代码是否有基准测试

**审查要点**:
- [ ] 是否使用 Criterion.rs
- [ ] 基准测试是否在 benches 目录
- [ ] 是否比较不同实现的性能

---

### 10.2 基准测试质量

**维度说明**: 基准测试是否有效

**审查要点**:
- [ ] 是否使用足够多的迭代
- [ ] 是否分析内存分配
- [ ] 是否提供比较图表

---

## 维度 11: 错误处理测试

### 11.1 Result 测试

**维度说明**: Result 返回是否被测试

**审查要点**:
- [ ] Ok 分支是否被测试
- [ ] Err 分支是否被测试
- [ ] 错误类型是否被验证

---

### 11.2 ? 操作符测试

**维度说明**: 错误传播是否被测试

**审查要点**:
- [ ] 早期返回是否被测试
- [ ] 错误转换是否被测试
- [ ] 错误上下文是否被添加

---

## 维度 12: 生命周期测试

### 12.1 生命周期边界

**维度说明**: 生命周期相关代码是否被测试

**审查要点**:
- [ ] 生命周期参数是否被测试
- [ ] 借用检查错误是否被测试
- [ ] 生命周期子类型是否被测试

---

## 维度 13: Unsafe 测试

### 13.1 Unsafe 块测试

**维度说明**: unsafe 代码是否充分测试

**审查要点**:
- [ ] unsafe 块是否有安全注释
- [ ] unsafe 代码是否有专门测试
- [ ] 边界条件是否被测试

---

## 维度 14: Rust 特定

### 14.1 Clone/Copy 测试

**审查要点**:
- [ ] Clone 实现是否正确
- [ ] Copy 派生是否合理
- [ ] 深拷贝 vs 浅拷贝是否理解

---

### 14.2 Debug/Display 测试

**审查要点**:
- [ ] Debug 实现是否被测试
- [ ] Display 实现是否被测试
- [ ] 输出格式是否符合预期

---

## 质量评估矩阵

| 维度 | 权重 | 评估标准 | 评分 (1-5) |
|-----|------|---------|-----------|
| 测试结构 | 10% | 组织规范、命名清晰 | |
| 测试覆盖 | 25% | 快乐/边界/错误场景完整 | |
| 断言使用 | 10% | 正确使用、消息清晰 | |
| 属性测试 | 15% | proptest 使用、属性有意义 | |
| 测试隔离 | 10% | 独立无依赖 | |
| 并发测试 | 15% | 竞态检测、通道测试 | |
| 覆盖率 | 10% | ≥80% | |
| 可维护性 | 5% | 代码清晰、高效 | |

**总分**: ___ / 5

---

## 审查结果汇总模板

```markdown
# Rust 测试质量审查报告

## 审查概述
- 编程语言: Rust
- 测试框架: 内置测试框架 / proptest
- 审查时间: YYYY-MM-DD HH:MM
- 审查测试文件: X个
- 审查测试用例: Y个

## 审查框架
基于 `templates/testing/testing-checklist-rust.md` 提供的审查维度：
1. 测试结构 (组织、命名)
2. 测试覆盖 (快乐路径、边界条件、错误场景)
3. 断言使用 (宏使用、调试断言)
4. 属性测试 (proptest 使用、属性质量)
5. 测试隔离 (独立性、文件系统隔离)
6. Mock 和隔离 (Trait Mock、Mock 库)
7. 并发测试 (并发安全、通道、同步原语)
8. 覆盖率 (目标、配置)
9. 文档测试 (文档示例、质量)
10. 基准测试 (Criterion 使用、质量)
11. 错误处理测试 (Result、? 操作符)
12. 生命周期测试
13. Unsafe 测试
14. Rust 特定 (Clone/Copy、Debug/Display)

## 各维度深度审查

### 1. 测试结构维度
**分析结果**: ___
**问题列表**: ___
**改进建议**: ___

### 2. 测试覆盖维度
**分析结果**: ___
... [其他维度]

## 覆盖率分析
- 语句覆盖率: XX%
- 分支覆盖率: XX%
- 未覆盖关键路径: [列表]

## 总体评估与优先级
- 质量等级: ___
- 总分: X.X / 5.0
- 高优先级问题: [列表]
- 中优先级问题: [列表]
- 低优先级问题: [列表]

## 改进计划
1. [ ] [具体行动项]
2. [ ] [具体行动项]
3. [ ] [具体行动项]
```
