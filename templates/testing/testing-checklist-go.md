# Go 单元测试 Checklist

> 本文档提供 Go 单元测试的审查维度框架
> 基于 testing 包、表格驱动测试、接口等最佳实践

## 审查维度说明

本文档不是简单的检查表，而是提供**测试代码的审查维度和框架**。基于这些维度对测试进行深度分析，识别问题和改进空间。

---

## 维度 1: 测试结构

### 1.1 表格驱动测试

**维度说明**: 是否使用表格驱动测试模式组织测试

**审查要点**:
- [ ] 相似测试是否使用表格驱动模式
- [ ] 测试用例是否结构化定义
- [ ] 子测试是否使用 t.Run()
- [ ] 测试用例是否有描述性名称

**深度分析方向**:
- 识别可以使用表格驱动的重复测试代码
- 表格测试的可读性和可维护性

---

### 1.2 测试命名规范

**维度说明**: 测试函数命名是否清晰描述测试意图

**审查要点**:
- [ ] 测试名称是否遵循 TestFunctionName 模式
- [ ] 子测试名称是否描述具体场景
- [ ] 测试名称是否能独立表达测试意图

---

### 1.3 测试文件组织

**维度说明**: 测试文件是否正确组织

**审查要点**:
- [ ] 测试文件是否命名为 xxx_test.go
- [ ] 测试文件是否与源文件在同一包
- [ ] 黑盒测试是否使用独立包

---

## 维度 2: 测试覆盖

### 2.1 快乐路径覆盖

**维度说明**: 正常场景是否都有测试覆盖

**审查要点**:
- [ ] 主要功能路径是否都有测试
- [ ] 核心业务逻辑是否被测试
- [ ] 公共 API 是否被测试

---

### 2.2 边界条件测试

**维度说明**: 边界值、空值、极值等特殊场景是否测试

**审查要点**:
- [ ] nil / 空切片 / 空映射处理是否测试
- [ ] 零值是否测试
- [ ] 整数溢出边界是否测试
- [ ] 切边界界是否测试

---

### 2.3 错误场景覆盖

**维度说明**: 错误返回是否被测试

**审查要点**:
- [ ] 错误返回是否被测试
- [ ] 错误类型是否被验证
- [ ] 错误信息是否有意义
- [ ] panic 场景是否测试

---

## 维度 3: 接口和 Mock

### 3.1 接口使用

**维度说明**: 是否通过接口定义依赖以便测试

**审查要点**:
- [ ] 依赖是否定义为接口
- [ ] 接口是否小而专注
- [ ] 生产代码和测试代码是否使用相同接口

---

### 3.2 Mock 实现

**维度说明**: 是否正确实现接口 mock

**审查要点**:
- [ ] 是否使用代码生成 mock（如 mockgen）
- [ ] Mock 实现是否在 _test.go 文件中
- [ ] Mock 行为是否可配置

---

### 3.3 测试替身选择

**维度说明**: 是否选择合适的测试替身

**审查要点**:
- [ ] 简单场景是否使用 fake 对象
- [ ] 复杂场景是否使用 mock 框架
- [ ] 是否避免过度使用 mock

---

## 维度 4: 并发测试

### 4.1 并发安全测试

**维度说明**: 并发代码是否有相应测试

**审查要点**:
- [ ] 是否使用 t.Parallel() 标记可并行测试
- [ ] 并发安全代码是否有竞态检测
- [ ] 是否使用 go test -race 运行

**深度分析方向**:
- 识别竞态条件风险
- 并发测试的有效性

---

### 4.2 通道测试

**维度说明**: 通道操作是否被正确测试

**审查要点**:
- [ ] 发送/接收是否被测试
- [ ] 通道关闭是否被测试
- [ ] select 语句是否被测试
- [ ] 死锁场景是否被测试

---

### 4.3 同步原语测试

**维度说明**: WaitGroup、Mutex 等是否被正确测试

**审查要点**:
- [ ] WaitGroup 使用是否被测试
- [ ] Mutex 锁竞争是否被测试
- [ ] Once 使用是否被测试
- [ ] Cond 使用是否被测试

---

## 维度 5: 测试断言

### 5.1 错误断言

**维度说明**: 错误是否被正确断言

**审查要点**:
- [ ] 是否使用 errors.Is 比较错误
- [ ] 是否使用 errors.As 提取错误类型
- [ ] 是否避免字符串比较错误消息

---

### 5.2 值比较断言

**维度说明**: 值比较是否使用正确的方法

**审查要点**:
- [ ] 是否使用 reflect.DeepEqual 比较复杂类型
- [ ] 是否使用 cmp.Equal（可选）
- [ ] 相等比较是否考虑指针语义

---

### 5.3 断言辅助函数

**维度说明**: 是否使用断言辅助库

**审查要点**:
- [ ] 是否使用 testify/assert
- [ ] 断言消息是否有描述性
- [ ] 是否避免过弱断言

---

## 维度 6: 测试隔离

### 6.1 测试独立性

**维度说明**: 测试之间是否相互独立

**审查要点**:
- [ ] 测试执行顺序是否影响结果
- [ ] 是否避免共享状态
- [ ] 每个测试是否清理自己的状态

---

### 6.2 Setup/Teardown

**维度说明**: 是否正确使用 setup/teardown

**审查要点**:
- [ ] 是否使用 TestMain 进行全局 setup
- [ ] 是否正确清理资源
- [ ] defer 语句是否正确使用

---

## 维度 7: 基准测试

### 7.1 基准测试覆盖

**维度说明**: 性能关键代码是否有基准测试

**审查要点**:
- [ ] 性能关键函数是否有 BenchmarkXxx
- [ ] 基准测试是否使用 b.ResetTimer()
- [ ] 基准测试是否使用 b.Run() 进行子基准

---

### 7.2 基准测试质量

**维度说明**: 基准测试是否有效

**审查要点**:
- [ ] 是否避免在基准测试中进行不必要的初始化
- [ ] 是否使用足够多的迭代次数
- [ ] 是否分析内存分配（benchmem）

---

## 维度 8: 示例测试

### 8.1 示例函数

**维度说明**: 是否提供示例函数

**审查要点**:
- [ ] 公共 API 是否有 ExampleXxx
- [ ] 示例是否有清晰的注释
- [ ] 示例输出是否使用 // Output: 注释

---

### 8.2 示例质量

**维度说明**: 示例是否有助于理解

**审查要点**:
- [ ] 示例是否展示真实用法
- [ ] 示例是否完整可运行
- [ ] 示例是否通过 go test 验证

---

## 维度 9: 模糊测试

### 9.1 Fuzz 测试

**维度说明**: 关键代码是否有模糊测试

**审查要点**:
- [ ] 解析/序列化代码是否有 FuzzXxx
- [ ] 模糊目标是否选择合适
- [ ] 是否使用语料文件

---

## 维度 10: 测试覆盖率

### 10.1 覆盖率目标

**维度说明**: 测试覆盖率是否达到 80% 以上

**审查要点**:
- [ ] 语句覆盖率是否 ≥ 80%
- [ ] 是否使用 go test -cover 检查
- [ ] 覆盖率报告是否定期生成

---

### 10.2 覆盖率模式

**维度说明**: 覆盖率模式是否正确

**审查要点**:
- [ ] 是否使用 set=mode:atomic
- [ ] 是否使用 set=mode:set （如适用）
- [ ] 覆盖率排除是否合理

---

## 维度 11: 子测试

### 11.1 t.Run 使用

**维度说明**: 是否有效使用子测试

**审查要点**:
- [ ] 相关测试是否组织为子测试
- [ ] 子测试名称是否描述性
- [ ] 是否使用 t.Parallel() 并行执行子测试

---

### 11.2 子测试清理

**维度说明**: 子测试清理是否正确

**审查要点**:
- [ ] defer 清理是否在正确的位置
- [ ] t.Cleanup() 是否被使用

---

## 维度 12: 测试辅助

### 12.1 测试辅助函数

**维度说明**: 是否正确使用测试辅助函数

**审查要点**:
- [ ] 辅助函数是否以 _test.go 结尾
- [ ] 辅助函数是否接受 *testing.T 参数
- [ ] 辅助函数是否在需要时调用 t.Fatal()

---

### 12.2 环境变量处理

**维度说明**: 环境变量是否正确处理

**审查要点**:
- [ ] 测试是否使用 t.Setenv()
- [ ] 环境变量隔离是否正确
- [ ] 测试后环境变量是否恢复

---

## 维度 13: HTTP 测试

### 13.1 httputil 使用

**维度说明**: HTTP 处理器是否正确测试

**审查要点**:
- [ ] 是否使用 httptest.NewRecorder
- [ ] 是否使用 httptest.NewServer
- [ ] 服务器是否在测试后关闭

---

### 13.2 HTTP 客户端测试

**维度说明**: HTTP 客户端是否正确测试

**审查要点**:
- [ ] 是否使用 mock 服务器
- [ ] 请求/响应是否被验证
- [ ] 错误场景是否被测试

---

## 维度 14: 数据库测试

### 14.1 数据库测试隔离

**维度说明**: 数据库测试是否正确隔离

**审查要点**:
- [ ] 是否使用内存数据库或测试数据库
- [ ] 是否使用事务回滚清理数据
- [ ] 每个测试是否有独立的数据状态

---

### 14.2 数据库 Mock

**维度说明**: 是否使用 sqlmock

**审查要点**:
- [ ] 数据库查询是否被 mock
- [ ] 期望是否正确设置
- [ ] 错误场景是否被测试

---

## 维度 15: Go 模块

### 15.1 模块依赖

**维度说明**: 模块依赖是否合理

**审查要点**:
- [ ] go.mod 是否最新
- [ ] 是否使用 replace 指令（如需要）
- [ ] 依赖是否合理

---

## 质量评估矩阵

| 维度 | 权重 | 评估标准 | 评分 (1-5) |
|-----|------|---------|-----------|
| 测试结构 | 15% | 表格驱动、命名规范 | |
| 测试覆盖 | 20% | 快乐/边界/错误场景完整 | |
| 接口和 Mock | 15% | 接口设计、Mock 合理 | |
| 并发测试 | 15% | 竞态检测、通道测试 | |
| 测试隔离 | 10% | 独立无依赖 | |
| 断言质量 | 10% | 完整、准确 | |
| 覆盖率 | 10% | ≥80% | |
| 可维护性 | 5% | 代码清晰、高效 | |

**总分**: ___ / 5

**质量等级**:
- 4.5-5.0: 优秀 - 测试质量卓越
- 4.0-4.4: 良好 - 测试质量优秀，有小幅改进空间
- 3.5-3.9: 合格 - 测试质量达标，有明显改进空间
- 3.0-3.4: 需改进 - 测试存在较多问题
- < 3.0: 不合格 - 测试质量严重不足

---

## 审查结果汇总模板

```markdown
# Go 测试质量审查报告

## 审查概述
- 编程语言: Go
- 测试框架: testing
- 审查时间: YYYY-MM-DD HH:MM
- 审查测试文件: X个
- 审查测试用例: Y个

## 审查框架
基于 `templates/testing/testing-checklist-go.md` 提供的审查维度：
1. 测试结构 (表格驱动、命名规范、文件组织)
2. 测试覆盖 (快乐路径、边界条件、错误场景)
3. 接口和 Mock (接口使用、Mock 实现、测试替身)
4. 并发测试 (并发安全、通道、同步原语)
5. 测试断言 (错误断言、值比较、辅助函数)
6. 测试隔离 (独立性、Setup/Teardown)
7. 基准测试 (覆盖率、质量)
8. 示例测试 (示例函数、质量)
9. 模糊测试 (Fuzz 测试)
10. 覆盖率 (目标、模式)
11. 子测试 (t.Run 使用、清理)
12. 测试辅助 (辅助函数、环境变量)
13. HTTP 测试 (httputil、客户端)
14. 数据库测试 (隔离、Mock)
15. Go 模块 (依赖管理)

## 各维度深度审查

### 1. 测试结构维度
**分析结果**: ___
**问题列表**: ___
**改进建议**: ___

### 2. 测试覆盖维度
**分析结果**: ___
... [其他维度]

## 覆盖率分析
- 语句覆盖率: XX%
- 未覆盖关键路径: [列表]
- 竞态检测: 通过/失败

## 总体评估与优先级
- 质量等级: ___
- 总分: X.X / 5.0
- 高优先级问题: [列表]
- 中优先级问题: [列表]
- 低优先级问题: [列表]

## 改进计划
1. [ ] [具体行动项]
2. [ ] [具体行动项]
3. [ ] [具体行动项]
```
