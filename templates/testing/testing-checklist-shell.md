# Shell 单元测试 Checklist

> 本文档提供 Shell 单元测试的审查维度框架
> 基于 Bats、shunit2 等最佳实践

## 审查维度说明

本文档不是简单的检查表，而是提供**测试代码的审查维度和框架**。基于这些维度对测试进行深度分析，识别问题和改进空间。

**相关 Skill**: `shell-scripting:bats-testing-patterns`

---

## 维度 1: 测试结构

### 1.1 测试组织

**维度说明**: 测试是否正确组织

**审查要点**:
- [ ] 测试文件是否以 .bats 结尾 (Bats)
- [ ] 测试文件命名是否描述性
- [ ] 测试是否按功能分组

---

### 1.2 测试命名规范

**维度说明**: 测试用例命名是否清晰

**审查要点**:
- [ ] @test 名称是否描述性
- [ ] 测试名称是否能表达测试意图
- [ ] 是否避免模糊的名称 (test1, test_it)

---

## 维度 2: Bats 特性

### 2.1 @test 使用

**维度说明**: 测试是否正确使用 @test

**审查要点**:
- [ ] 每个测试是否以 @test 开始
- [ ] 测试名称是否描述性
- [ ] 测试体是否简洁

---

### 2.2 Setup/Teardown

**维度说明**: 是否使用 setup/teardown

**审查要点**:
- [ ] setup() 是否在测试前执行
- [ ] teardown() 是否在测试后执行
- [ ] 资源是否在 teardown 中清理

---

### 2.3 Helper 函数

**维度说明**: 是否使用辅助函数

**审查要点**:
- [ ] 重复代码是否提取为函数
- [ ] 辅助函数命名是否清晰
- [ ] 辅助函数是否放在测试文件顶部

---

## 维度 3: 断言使用

### 3.1 assert 使用

**维度说明**: 是否使用正确的断言

**审查要点**:
- [ ] 是否使用 assert [condition]
- [ ] 是否使用 assert_equal
- [ ] 是否使用 assert_success / assert_failure
- [ ] 是否使用 assert_output

---

### 3.2 run 命令使用

**维度说明**: 是否正确使用 run 命令

**审查要点**:
- [ ] 被测试命令是否使用 run 执行
- [ ] $status 是否被验证
- [ ] $output 是否被验证
- [ ] $lines 是否被使用

---

### 3.3 断言消息

**维度说明**: 断言失败是否有清晰消息

**审查要点**:
- [ ] 断言失败是否有描述性消息
- [ ] 消息是否帮助定位问题

---

## 维度 4: 测试覆盖

### 4.1 快乐路径覆盖

**维度说明**: 正常场景是否都有测试覆盖

**审查要点**:
- [ ] 主要功能路径是否都有测试
- [ ] 公共函数是否被测试
- [ ] 核心逻辑是否被测试

---

### 4.2 边界条件测试

**维度说明**: 边界值、空值等特殊场景是否测试

**审查要点**:
- [ ] 空字符串是否测试
- [ ] 空数组是否测试
- [ ] 零值是否测试
- [ ] 参数边界是否测试

---

### 4.3 错误场景覆盖

**维度说明**: 错误返回是否被测试

**审查要点**:
- [ ] 错误退出码是否被测试
- [ ] 错误消息是否被测试
- [ ] 缺少参数是否被测试
- [ ] 无效输入是否被测试

---

## 维度 5: Mock 和隔离

### 5.1 命令 Mock

**维度说明**: 是否正确 mock 命令

**审查要点**:
- [ ] 外部命令是否被 mock
- [ ] mock 命令是否在测试后取消
- [ ] mock 返回值是否符合场景

---

### 5.2 函数 Mock

**维度说明**: 是否正确 mock 函数

**审查要点**:
- [ ] 源文件中的函数是否被 mock
- [ ] mock 函数是否在测试后取消
- [ ] 是否使用 export -f 取消

---

### 5.3 环境变量隔离

**维度说明**: 环境变量是否正确隔离

**审查要点**:
- [ ] 测试设置的环境变量是否清理
- [ ] 是否使用 export/unexport
- [ ] 是否避免修改真实环境

---

## 维度 6: 文件系统测试

### 6.1 临时文件使用

**维度说明**: 是否使用临时文件

**审查要点**:
- [ ] 是否使用 $BATS_TMPDIR
- [ ] 临时文件是否在 teardown 中删除
- [ ] 是否避免使用真实文件系统

---

### 6.2 目录操作测试

**维度说明**: 目录操作是否被测试

**审查要点**:
- [ ] 创建目录是否被测试
- [ ] 删除目录是否被测试
- [ ] 目录不存在时是否处理

---

## 维度 7: 测试隔离

### 7.1 测试独立性

**维度说明**: 测试之间是否相互独立

**审查要点**:
- [ ] 测试执行顺序是否影响结果
- [ ] 是否避免共享状态
- [ ] 每个测试是否清理自己的状态

---

### 7.2 Side Effect 清理

**维度说明**: 副作用是否被清理

**审查要点**:
- [ ] 创建的文件是否删除
- [ ] mock 的命令是否取消
- [ ] 修改的环境变量是否恢复

---

## 维度 8: 输出验证

### 8.1 标准输出验证

**维度说明**: 标准输出是否被验证

**审查要点**:
- [ ] $output 是否被验证
- [ ] 部分输出是否被验证 (grep)
- [ ] 输出格式是否被验证

---

### 8.2 标准错误验证

**维度说明**: 标准错误是否被验证

**审查要点**:
- [ ] 错误消息是否被验证
- [ ] 错误输出是否包含有用信息
- [ ] 错误级别是否合理

---

### 8.3 退出码验证

**维度说明**: 退出码是否被验证

**审查要点**:
- [ ] $status 是否被验证
- [ ] 成功退出码是否为 0
- [ ] 错误退出码是否合理

---

## 维度 9: shunit2 特性

### 9.1 断言使用

**维度说明**: 是否使用正确的 shunit2 断言

**审查要点**:
- [ ] 是否使用 assertEquals
- [ ] 是否使用 assertNotEquals
- [ ] 是否使用 assertTrue/False
- [ ] 是否使用 assertNull/NotNull

---

### 9.2 Setup/Teardown

**维度说明**: 是否使用 oneTimeSetUp/tearDown

**审查要点**:
- [ ] oneTimeSetUp 是否正确使用
- [ ] oneTimeTearDown 是否正确使用
- [ ] setUp/tearDown 是否正确使用

---

## 维度 10: Shell 脚本质量

### 10.1 Shellcheck 检查

**维度说明**: 是否通过 Shellcheck 检查

**审查要点**:
- [ ] 测试脚本是否通过 Shellcheck
- [ ] 被测试脚本是否通过 Shellcheck
- [ ] Shellcheck 警告是否修复

---

### 10.2 可移植性

**维度说明**: 脚本是否可移植

**审查要点**:
- [ ] 是否依赖特定 Shell
- [ ] 是否使用 POSIX 兼容语法
- [ ] 是否在 shebang 中指定 Shell

---

## 维度 11: 参数测试

### 11.1 参数验证

**维度说明**: 函数参数是否被验证

**审查要点**:
- [ ] 参数数量是否被验证
- [ ] 参数类型是否被验证
- [ ] 参数边界是否被测试

---

### 11.2 选项解析测试

**维度说明**: getopts 是否被测试

**审查要点**:
- [ ] 短选项是否被测试
- [ ] 长选项是否被测试
- [ ] 选项参数是否被测试
- [ ] 无效选项是否被测试

---

## 维度 12: 错误处理

### 12.1 错误处理测试

**维度说明**: 错误处理是否被测试

**审查要点**:
- [ ] set -e 是否被测试
- [ ] 错误是否被捕获
- [ ] 错误是否被正确处理

---

### 12.2 Trap 测试

**维度说明**: trap 是否被测试

**审查要点**:
- [ ] EXIT trap 是否被测试
- [ ] ERR trap 是否被测试
- [ ] INT/TERM trap 是否被测试

---

## 维度 13: 并发测试

### 13.1 后台任务测试

**维度说明**: 后台任务是否被测试

**审查要点**:
- [ ] 后台任务是否被等待 (wait)
- [ ] 后台任务退出码是否被检查
- [ ] 并发问题是否被测试

---

## 维度 14: 测试覆盖率

### 14.1 覆盖率目标

**维度说明**: 测试覆盖率是否达到 80% 以上

**审查要点**:
- [ ] 是否使用 kcov 或 bashcov
- [ ] 语句覆盖率是否 ≥ 80%
- [ ] 分支覆盖率是否 ≥ 80%

---

### 14.2 覆盖率配置

**维度说明**: 覆盖率工具是否正确配置

**审查要点**:
- [ ] kcov 是否正确配置
- [ ] 排除规则是否合理
- [ ] CI 中是否生成覆盖率报告

---

## 质量评估矩阵

| 维度 | 权重 | 评估标准 | 评分 (1-5) |
|-----|------|---------|-----------|
| 测试结构 | 10% | 组织规范、命名清晰 | |
| 测试覆盖 | 25% | 快乐/边界/错误场景完整 | |
| 断言使用 | 15% | 正确使用、消息清晰 | |
| Mock 和隔离 | 15% | 正确隔离、清理完整 | |
| 测试隔离 | 10% | 独立无依赖 | |
| 输出验证 | 10% | stdout/stderr/status 完整 | |
| 覆盖率 | 10% | ≥80% | |
| Shell 质量 | 5% | 通过 Shellcheck、可移植 | |

**总分**: ___ / 5

---

## 与 Skill 的集成映射

| 维度 | shell-scripting:bats-testing-patterns | 关键模式 |
|-----|--------------------------------------|---------|
| 测试结构 | ✅ | Bats Test Structure |
| 断言使用 | ✅ | Assertions |
| Mock 隔离 | ✅ | Mocking Commands |
| 文件系统测试 | ✅ | File System Testing |

---

## 审查结果汇总模板

```markdown
# Shell 测试质量审查报告

## 审查概述
- 语言: Shell (Bash/Sh)
- 测试框架: Bats / shunit2
- 审查时间: YYYY-MM-DD HH:MM
- 审查测试文件: X个
- 审查测试用例: Y个

## 审查框架
基于 `templates/testing/testing-checklist-shell.md` 提供的审查维度：
1. 测试结构 (组织、命名)
2. Bats 特性 (@test、setup/teardown、helper)
3. 断言使用 (assert、run、消息)
4. 测试覆盖 (快乐路径、边界条件、错误场景)
5. Mock 和隔离 (命令mock、函数mock、环境变量)
6. 文件系统测试 (临时文件、目录操作)
7. 测试隔离 (独立性、副作用清理)
8. 输出验证 (stdout、stderr、退出码)
9. shunit2 特性 (断言、setup/teardown)
10. Shell 脚本质量 (Shellcheck、可移植性)
11. 参数测试 (参数验证、选项解析)
12. 错误处理 (错误处理、trap)
13. 并发测试 (后台任务)
14. 覆盖率 (目标、配置)

## 各维度深度审查

### 1. 测试结构维度
**分析结果**: ___
**集成 Skill**: shell-scripting:bats-testing-patterns
**问题列表**: ___
**改进建议**: ___

### 2. 测试覆盖维度
**分析结果**: ___
... [其他维度]

## 覆盖率分析
- 语句覆盖率: XX%
- 分支覆盖率: XX%
- Shellcheck: 通过 / 失败

## 总体评估与优先级
- 质量等级: ___
- 总分: X.X / 5.0
- 高优先级问题: [列表]
- 中优先级问题: [列表]
- 低优先级问题: [列表]

## 改进计划
1. [ ] [具体行动项]
2. [ ] [具体行动项]
3. [ ] [具体行动项]

## Skill 集成记录
- 调用的 Skills: shell-scripting:bats-testing-patterns
- 获取的最佳实践: [总结]
```
