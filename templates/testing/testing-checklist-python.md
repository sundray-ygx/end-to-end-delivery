# Python 单元测试 Checklist

> 本文档提供 Python 单元测试的审查维度框架
> 基于 pytest、fixtures、mocking 等最佳实践

## 审查维度说明

本文档不是简单的检查表，而是提供**测试代码的审查维度和框架**。基于这些维度对测试进行深度分析，识别问题和改进空间。

**相关 Skill**: `python-development:python-testing-patterns`

---

## 维度 1: 测试结构

### 1.1 AAA 模式遵循

**维度说明**: 测试是否遵循 Arrange-Act-Assert 模式

**审查要点**:
- [ ] 测试代码是否清晰划分为三个阶段
- [ ] Arrange 阶段是否准备完整的测试数据
- [ ] Act 阶段是否只执行被测试的单一操作
- [ ] Assert 阶段是否验证所有关键行为

**深度分析方向**:
- 测试结构是否清晰易读
- 是否有混淆 Arrange/Act/Assert 边界的代码
- 是否有缺失的 Assert（只调用不验证）

**相关模式**: python-testing-patterns - "Test Structure (AAA Pattern)"

---

### 1.2 测试命名规范

**维度说明**: 测试函数/方法命名是否清晰描述测试意图

**审查要点**:
- [ ] 测试名称是否遵循 `test_<function>_<scenario>_<expected>` 模式
- [ ] 测试名称是否能独立表达测试意图
- [ ] 是否避免使用模糊的测试名称（如 test1, test_it_works）

**深度分析方向**:
- 测试失败时，名称是否能快速定位问题
- 是否需要查看测试代码才能理解测试目的

---

## 维度 2: 测试覆盖

### 2.1 快乐路径覆盖

**维度说明**: 正常场景是否都有测试覆盖

**审查要点**:
- [ ] 主要功能路径是否都有测试
- [ ] 核心业务逻辑是否被测试
- [ ] 常见使用场景是否覆盖

**深度分析方向**:
- 识别未测试的核心功能
- 评估缺失测试的风险等级

---

### 2.2 边界条件测试

**维度说明**: 边界值、空值、极值等特殊场景是否测试

**审查要点**:
- [ ] 空值/None 处理是否测试
- [ ] 零值、负值是否测试
- [ ] 最大/最小边界值是否测试
- [ ] 集合为空的情况是否测试

**深度分析方向**:
- 识别可能导致问题的边界场景
- 边界测试是否充分

**相关模式**: python-testing-patterns - "Parameterized Tests"

---

### 2.3 错误场景覆盖

**维度说明**: 异常、错误输入是否被测试

**审查要点**:
- [ ] 异常抛出是否被测试
- [ ] 错误输入是否被测试
- [ ] 失败场景是否被测试
- [ ] 使用 pytest.raises() 验证异常

**深度分析方向**:
- 错误处理逻辑是否正确
- 异常类型是否准确
- 错误信息是否有意义

---

## 维度 3: Fixture 使用

### 3.1 Fixture 设计

**维度说明**: 是否有效使用 pytest fixtures 管理测试数据

**审查要点**:
- [ ] 重复的测试数据是否提取为 fixture
- [ ] Fixture 作用域是否合理（function/class/module/session）
- [ ] Fixture 是否有清晰的命名
- [ ] 是否避免 fixture 过度抽象

**深度分析方向**:
- Fixture 复用性和可维护性
- Fixture 依赖关系是否清晰

**相关模式**: python-testing-patterns - "Pytest Fixtures"

---

### 3.2 Fixture 作用域管理

**维度说明**: Fixture 作用域选择是否恰当

**审查要点**:
- [ ] function 作用域：每个测试独立创建
- [ ] class 作用域：类内测试共享
- [ ] module 作用域：模块内测试共享
- [ ] session 作用域：全局共享（谨慎使用）

**深度分析方向**:
- 作用域选择是否平衡性能和隔离性
- 是否有状态污染问题

---

### 3.3 Fixture 清理

**维度说明**: Fixture 是否正确清理资源

**审查要点**:
- [ ] 使用 yield 提供资源
- [ ] yield 后的清理代码是否执行
- [ ] 数据库连接是否关闭
- [ ] 临时文件是否删除

---

## 维度 4: Mock 和隔离

### 4.1 外部依赖隔离

**维度说明**: 是否正确 mock 外部依赖（数据库、API、文件系统）

**审查要点**:
- [ ] 数据库操作是否被 mock
- [ ] 网络 API 调用是否被 mock
- [ ] 文件系统操作是否被 mock
- [ ] 时间相关的函数是否被 mock

**深度分析方向**:
- Mock 是否隔离了真正的外部依赖
- Mock 行为是否符合真实场景

**相关模式**: python-testing-patterns - "Mocking with unittest.mock"

---

### 4.2 Mock 使用合理性

**维度说明**: Mock 的使用是否合理，不过度也不遗漏

**审查要点**:
- [ ] 是否避免过度 mock（测试 mock 本身而非业务逻辑）
- [ ] Mock 返回值是否符合真实场景
- [ ] 是否验证 mock 的调用（使用 assert_called_with）

**深度分析方向**:
- 识别过度 mock 的测试
- 识别缺少 mock 的集成测试

---

### 4.3 Patch 目标准确性

**维度说明**: 使用 patch 时目标是否正确

**审查要点**:
- [ ] patch 位置是否在代码使用处而非定义处
- [ ] patch 上下文管理是否正确
- [ ] patch 是否在测试后正确恢复

---

## 维度 5: 参数化测试

### 5.1 参数化使用

**维度说明**: 是否使用 @pytest.mark.parametrize 减少重复测试代码

**审查要点**:
- [ ] 相同逻辑不同数据的测试是否参数化
- [ ] 参数化测试用例是否有清晰的命名（ids 参数）
- [ ] 参数化测试是否覆盖边界组合

**深度分析方向**:
- 识别可以参数化的重复测试代码
- 参数化测试的可读性

**相关模式**: python-testing-patterns - "Parameterized Tests"

---

### 5.2 参数化测试覆盖

**维度说明**: 参数化测试的测试数据是否全面

**审查要点**:
- [ ] 是否覆盖正常值、边界值、异常值
- [ ] 测试数据组合是否有意义
- [ ] 是否使用 pytest.param 标记特殊用例

---

## 维度 6: 测试隔离

### 6.1 测试独立性

**维度说明**: 测试之间是否相互独立，无共享状态

**审查要点**:
- [ ] 测试执行顺序是否影响结果
- [ ] 是否避免测试之间的数据依赖
- [ ] 每个测试是否清理自己的状态
- [ ] 是否使用 fixture 的 autouse 清理

**深度分析方向**:
- 识别有依赖关系的测试
- 并行执行测试的可行性

---

### 6.2 数据库事务隔离

**维度说明**: 数据库测试是否正确隔离

**审查要点**:
- [ ] 是否使用事务回滚而非删除数据
- [ ] 每个测试是否在独立事务中运行
- [ ] 是否避免测试数据残留

---

## 维度 7: 测试断言

### 7.1 断言完整性

**维度说明**: 断言是否验证所有关键行为

**审查要点**:
- [ ] 是否验证返回值
- [ ] 是否验证副作用（如状态变化、数据库写入）
- [ ] 是否验证异常（在错误场景）
- [ ] 是否避免过弱断言（如 assert True）

**深度分析方向**:
- 识别缺失的断言
- 识别无意义的断言

---

### 7.2 断言准确性

**维度说明**: 断言是否准确验证预期行为

**审查要点**:
- [ ] 断言条件是否准确反映业务需求
- [ ] 是否避免过于宽泛的断言
- [ ] 断言失败信息是否清晰（使用 msg 参数）

---

### 7.3 断言可读性

**维度说明**: 断言是否易于理解

**审查要点**:
- [ ] 是否使用 pytest 的断言重写
- [ ] 复杂断言是否有注释说明
- [ ] 自定义断言消息是否清晰

---

## 维度 8: 异步测试

### 8.1 异步代码测试

**维度说明**: 异步函数/协程是否被正确测试

**审查要点**:
- [ ] 异步测试是否使用 pytest-asyncio
- [ ] 是否正确 await 异步操作
- [ ] 异步边界情况是否测试

**深度分析方向**:
- 异步测试的超时设置
- 并发异步操作的测试

**相关模式**: python-testing-patterns - "Testing Async Code"

---

### 8.2 异步 Fixture

**维度说明**: 异步 fixture 是否正确使用

**审查要点**:
- [ ] 异步 fixture 使用 @pytest_asyncio.fixture
- [ ] 异步 fixture 的作用域是否正确
- [ ] 异步资源是否正确清理

---

## 维度 9: 测试覆盖率

### 9.1 覆盖率目标

**维度说明**: 测试覆盖率是否达到 80% 以上

**审查要点**:
- [ ] 语句覆盖率是否 ≥ 80%
- [ ] 分支覆盖率是否 ≥ 80%
- [ ] 未覆盖的代码是否有合理理由

**深度分析方向**:
- 识别关键路径的测试覆盖缺口
- 低覆盖代码的风险评估

---

### 9.2 覆盖率质量

**维度说明**: 覆盖率是否真实反映测试质量

**审查要点**:
- [ ] 是否避免为了覆盖率而编写无意义测试
- [ ] 未覆盖代码是否为死代码或防御性代码
- [ ] 覆盖率报告是否定期生成和审查

---

### 9.3 覆盖率配置

**维度说明**: 覆盖率工具是否正确配置

**审查要点**:
- [ ] pytest-cov 是否正确配置
- [ ] 覆盖率排除规则是否合理
- [ ] 是否配置了覆盖率阈值失败

---

## 维度 10: 测试可维护性

### 10.1 测试代码质量

**维度说明**: 测试代码本身是否易于维护

**审查要点**:
- [ ] 测试代码是否遵循 PEP 8
- [ ] 是否避免测试代码重复
- [ ] 测试是否有清晰的文档字符串
- [ ] 复杂测试是否有注释说明

**深度分析方向**:
- 测试代码的复杂度
- 测试的可读性

---

### 10.2 测试执行效率

**维度说明**: 测试执行时间是否合理

**审查要点**:
- [ ] 慢速测试是否标记（使用 @pytest.mark.slow）
- [ ] 是否避免不必要的 I/O 操作
- [ ] 是否使用 mock 加速测试
- [ ] 是否使用 xdist 并行执行

**深度分析方向**:
- 识别性能瓶颈测试
- 测试套件总执行时间评估

---

### 10.3 测试组织结构

**维度说明**: 测试文件和目录结构是否合理

**审查要点**:
- [ ] 测试文件是否遵循 test_*.py 或 *_test.py 命名
- [ ] 测试目录结构是否镜像源代码结构
- [ ] conftest.py 是否放在合适的位置

---

## 维度 11: 测试标记和分类

### 11.1 Marker 使用

**维度说明**: 是否使用 pytest markers 分类测试

**审查要点**:
- [ ] 慢速测试是否标记 @pytest.mark.slow
- [ ] 集成测试是否标记 @pytest.mark.integration
- [ ] 单元测试是否标记 @pytest.mark.unit
- [ ] 跳过测试是否标记 @pytest.mark.skip 并说明原因

---

### 11.2 Marker 配置

**维度说明**: Markers 是否在 pytest.ini 中声明

**审查要点**:
- [ ] markers 是否在配置文件中注册
- [ ] marker 是否有文档说明
- [ ] 是否避免使用未声明的 marker

---

## 维度 12: 临时文件和环境

### 12.1 临时目录使用

**维度说明**: 是否使用 tmp_path fixture 处理临时文件

**审查要点**:
- [ ] 临时文件是否使用 tmp_path fixture
- [ ] 临时文件是否在测试后自动清理
- [ ] 是否避免在项目目录创建测试文件

**相关模式**: python-testing-patterns - "Temporary Files and Directories"

---

### 12.2 环境变量处理

**维度说明**: 环境变量是否使用 monkeypatch 处理

**审查要点**:
- [ ] 环境变量是否使用 monkeypatch 设置
- [ ] 测试后环境变量是否恢复
- [ ] 是否避免修改真实环境变量

---

## 维度 13: 数据库测试

### 13.1 数据库测试隔离

**维度说明**: 数据库测试是否正确隔离

**审查要点**:
- [ ] 是否使用内存数据库或测试数据库
- [ ] 是否使用事务回滚清理数据
- [ ] 每个测试是否有独立的数据状态

**相关模式**: python-testing-patterns - "Testing Database Code"

---

### 13.2 数据库 Fixture

**维度说明**: 数据库 fixture 是否设计合理

**审查要点**:
- [ ] 数据库连接是否使用 fixture 管理
- [ ] 表结构初始化是否在 fixture 中完成
- [ ] 测试数据是否使用 fixture 加载

---

## 维度 14: 属性测试

### 14.1 Hypothesis 使用

**维度说明**: 是否使用 hypothesis 进行属性测试

**审查要点**:
- [ ] 关键属性是否使用 hypothesis 测试
- [ ] 是否测试不变量（invariants）
- [ ] 是否测试边界性质

**相关模式**: python-testing-patterns - "Property-Based Testing"

---

## 维度 15: Python 特定规范

### 15.1 PEP 8 遵循

**审查要点**:
- [ ] 测试代码是否遵循 PEP 8
- [ ] 测试文件命名是否符合 test_*.py 或 *_test.py 规范
- [ ] 测试类是否以 Test 开头
- [ ] 测试方法是否以 test_ 开头

---

### 15.2 Type Hint 使用

**审查要点**:
- [ ] 测试函数是否有类型注解
- [ ] Fixture 返回值是否有类型注解
- [ ] 测试辅助函数是否有类型注解

---

### 15.3 Docstring 使用

**审查要点**:
- [ ] 测试函数是否有描述性 docstring
- [ ] Fixture 是否有说明用途的 docstring
- [ ] 复杂测试逻辑是否有注释说明

---

## 质量评估矩阵

| 维度 | 权重 | 评估标准 | 评分 (1-5) |
|-----|------|---------|-----------|
| 测试结构 | 10% | AAA模式清晰、命名规范 | |
| 测试覆盖 | 20% | 快乐/边界/错误场景完整 | |
| Fixture 使用 | 15% | 合理使用、作用域恰当 | |
| Mock 隔离 | 15% | 正确隔离、不过度 | |
| 测试隔离 | 10% | 独立无依赖 | |
| 断言质量 | 10% | 完整、准确 | |
| 覆盖率 | 10% | ≥80% | |
| 可维护性 | 10% | 代码清晰、高效 | |

**总分**: ___ / 5

**质量等级**:
- 4.5-5.0: 优秀 - 测试质量卓越
- 4.0-4.4: 良好 - 测试质量优秀，有小幅改进空间
- 3.5-3.9: 合格 - 测试质量达标，有明显改进空间
- 3.0-3.4: 需改进 - 测试存在较多问题
- < 3.0: 不合格 - 测试质量严重不足

---

## 与 Skill 的集成映射

| 维度 | python-testing-patterns Skill | 关键模式 |
|-----|-------------------------------|---------|
| 测试结构 | ✅ | AAA Pattern |
| Fixture 使用 | ✅ | Pytest Fixtures |
| Mock 隔离 | ✅ | Mocking with unittest.mock |
| 参数化测试 | ✅ | Parameterized Tests |
| 异步测试 | ✅ | Testing Async Code |
| 覆盖率 | ✅ | Test Coverage |
| 数据库测试 | ✅ | Testing Database Code |
| 临时文件 | ✅ | Temporary Files and Directories |
| 属性测试 | ✅ | Property-Based Testing |

---

## 审查结果汇总模板

```markdown
# Python 测试质量审查报告

## 审查概述
- 编程语言: Python
- 测试框架: pytest
- 审查时间: YYYY-MM-DD HH:MM
- 审查测试文件: X个
- 审查测试用例: Y个

## 审查框架
基于 `templates/testing/testing-checklist-python.md` 提供的审查维度：
1. 测试结构 (AAA模式、命名规范)
2. 测试覆盖 (快乐路径、边界条件、错误场景)
3. Fixture 使用 (设计合理性、作用域、清理)
4. Mock 和隔离 (外部依赖隔离、使用合理性)
5. 参数化测试 (使用合理性、覆盖全面性)
6. 测试隔离 (独立性、数据库事务隔离)
7. 断言质量 (完整性、准确性、可读性)
8. 异步测试 (异步代码、异步 fixture)
9. 覆盖率 (语句覆盖、分支覆盖、质量)
10. 可维护性 (代码质量、执行效率、组织结构)

## 各维度深度审查

### 1. 测试结构维度
**分析结果**: ___
**集成 Skill**: python-testing-patterns (AAA Pattern)
**问题列表**: ___
**改进建议**: ___

### 2. 测试覆盖维度
**分析结果**: ___
... [其他维度]

## 覆盖率分析
- 语句覆盖率: XX%
- 分支覆盖率: XX%
- 函数覆盖率: XX%
- 未覆盖关键路径: [列表]

## 总体评估与优先级
- 质量等级: ___
- 总分: X.X / 5.0
- 高优先级问题: [列表]
- 中优先级问题: [列表]
- 低优先级问题: [列表]

## 改进计划
1. [ ] [具体行动项]
2. [ ] [具体行动项]
3. [ ] [具体行动项]

## Skill 集成记录
- 调用的 Skills: python-development:python-testing-patterns
- 获取的最佳实践: [总结]
```
