# C/C++ 单元测试 Checklist

> 本文档提供 C/C++ 单元测试的审查维度框架
> 基于 Google Test、Catch2 等最佳实践

## 审查维度说明

本文档不是简单的检查表，而是提供**测试代码的审查维度和框架**。基于这些维度对测试进行深度分析，识别问题和改进空间。

---

## 维度 1: 测试结构

### 1.1 测试组织

**维度说明**: 测试是否正确组织

**审查要点**:
- [ ] 测试文件是否与源文件分离
- [ ] 测试文件命名是否规范 (xxx_test.cc)
- [ ] 测试是否按模块组织

---

### 1.2 测试命名规范

**维度说明**: 测试用例命名是否清晰

**审查要点**:
- [ ] 测试名称是否描述性
- [ ] 是否使用 CamelCase 或 snake_case
- [ ] 测试名称是否能表达测试意图

---

## 维度 2: 测试覆盖

### 2.1 快乐路径覆盖

**维度说明**: 正常场景是否都有测试覆盖

**审查要点**:
- [ ] 主要功能路径是否都有测试
- [ ] 公共 API 是否被测试
- [ ] 核心业务逻辑是否被测试

---

### 2.2 边界条件测试

**维度说明**: 边界值、空值等特殊场景是否测试

**审查要点**:
- [ ] nullptr 处理是否测试
- [ ] 空容器是否测试
- [ ] INT_MAX/INT_MIN 是否测试
- [ ] 缓冲区边界是否测试

---

### 2.3 错误场景覆盖

**维度说明**: 错误返回是否被测试

**审查要点**:
- [ ] 错误码返回是否被测试
- [ ] 异常抛出是否被测试 (C++)
- [ ] errno 是否被验证
- [ ] 失败场景是否被测试

---

## 维度 3: Google Test 特性

### 3.1 断言使用

**维度说明**: 是否使用正确的断言宏

**审查要点**:
- [ ] 是否使用 EXPECT_* 非致命断言
- [ ] 是否使用 ASSERT_* 致命断言
- [ ] 断言消息是否提供
- [ ] 是否使用类型化断言 (EXPECT_EQ)

---

### 3.2 测试固件

**维度说明**: 是否有效使用测试固件

**审查要点**:
- [ ] 重复 setup 是否提取为固件
- [ ] SetUp/TearDown 是否正确使用
- [ ] 固件继承是否合理
- [ ] 是否使用 SetUpTestSuite/TearDownTestSuite

---

### 3.3 参数化测试

**维度说明**: 是否使用参数化测试减少重复

**审查要点**:
- [ ] 相同逻辑不同数据的测试是否参数化
- [ ] TEST_P 是否正确使用
- [ ] INSTANTIATE_TEST_SUITE_P 是否正确配置
- [ ] 测试参数是否有描述性名称

---

## 维度 4: Catch2 特性

### 4.1 BDD 风格

**维度说明**: 是否使用 BDD 风格的 SECTION

**审查要点**:
- [ ] 是否使用 GIVEN/WHEN/THEN
- [ ] SECTION 嵌套是否合理
- [ ] 测试描述是否清晰

---

### 4.2 Matcher 使用

**维度说明**: 是否使用 Catch2 matcher

**审查要点**:
- [ ] 是否使用丰富的 matcher (That, Equals)
- [ ] 是否使用字符串 matcher
- [ ] 是否使用容器 matcher
- [ ] 是否使用浮点 matcher (Approx)

---

### 4.3 测试固件

**审查要点**:
- [ ] 是否使用 Catch2 固件
- [ ] 构造/析构是否正确使用

---

## 维度 5: Mock 使用

### 5.1 Google Mock

**维度说明**: 是否使用 gMock

**审查要点**:
- [ ] Mock 类是否正确继承
- [ ] MOCK_METHOD 是否正确使用
- [ ] EXPECT_CALL 是否正确设置
- [ ] Times/With/WillOnce 是否正确使用

---

### 5.2 Mock 合理性

**维度说明**: Mock 使用是否合理

**审查要点**:
- [ ] 是否避免过度 mock
- [ ] Mock 返回值是否符合真实场景
- [ ] 是否验证 mock 调用

---

## 维度 6: 内存管理测试

### 6.1 内存泄漏测试

**维度说明**: 是否测试内存泄漏

**审查要点**:
- [ ] 是否使用 Valgrind 检测
- [ ] 是否使用 AddressSanitizer
- [ ] new/delete 是否配对
- [ ] malloc/free 是否配对

---

### 6.2 缓冲区溢出测试

**维度说明**: 是否测试缓冲区溢出

**审查要点**:
- [ ] 是否使用 AddressSanitizer
- [ ] 是否测试字符串长度限制
- [ ] 是否测试数组边界

---

### 6.3 智能指针测试 (C++)

**维度说明**: 智能指针使用是否被测试

**审查要点**:
- [ ] shared_ptr 引用计数是否被测试
- [ ] unique_ptr 独占所有权是否被测试
- [ ] weak_ptr 是否被测试
- [ ] 内存是否正确释放

---

## 维度 7: 测试隔离

### 7.1 测试独立性

**维度说明**: 测试之间是否相互独立

**审查要点**:
- [ ] 测试执行顺序是否影响结果
- [ ] 是否避免静态状态
- [ ] 是否避免全局变量污染

---

### 7.2 文件系统隔离

**维度说明**: 文件操作是否正确隔离

**审查要点**:
- [ ] 是否使用临时目录
- [ ] 测试后是否清理临时文件
- [ ] 是否避免使用真实文件系统

---

## 维度 8: 并发测试

### 8.1 线程安全测试

**维度说明**: 并发代码是否有相应测试

**审查要点**:
- [ ] 是否使用 ThreadSanitizer
- [ ] 是否测试数据竞争
- [ ] 是否使用多个线程测试

---

### 8.2 同步原语测试

**维度说明**: Mutex、Condition 等是否被测试

**审查要点**:
- [ ] std::mutex 锁竞争是否被测试
- [ ] std::condition_variable 是否被测试
- [ ] std::atomic 是否被测试
- [ ] 死锁场景是否被测试

---

## 维度 9: 测试覆盖率

### 9.1 覆盖率目标

**维度说明**: 测试覆盖率是否达到 80% 以上

**审查要点**:
- [ ] 是否使用 gcov/lcov
- [ ] 语句覆盖率是否 ≥ 80%
- [ ] 分支覆盖率是否 ≥ 80%

---

### 9.2 覆盖率配置

**维度说明**: 覆盖率工具是否正确配置

**审查要点**:
- [ ] 编译选项是否添加 --coverage
- [ ] CMakeLists.txt 是否配置
- [ ] CI 中是否生成覆盖率报告

---

## 维度 10: 异常测试 (C++)

### 10.1 异常抛出测试

**维度说明**: 异常是否被正确测试

**审查要点**:
- [ ] 是否使用 EXPECT_THROW
- [ ] 异常类型是否被验证
- [ ] 异常消息是否被验证

---

### 10.2 异常安全测试

**维度说明**: 异常安全是否被测试

**审查要点**:
- [ ] 基本异常安全是否保证
- [ ] 强异常安全是否保证
- [ ] 资源泄漏是否被测试

---

## 维度 11: 模板测试 (C++)

### 11.1 模板实例化测试

**维度说明**: 模板是否被测试

**审查要点**:
- [ ] 不同类型参数是否被测试
- [ ] 边界类型是否被测试
- [ ] 模板特化是否被测试

---

### 11.2 概念约束测试 (C++20)

**审查要点**:
- [ ] requires 约束是否被测试
- [ ] 约束失败是否有清晰错误

---

## 维度 12: C++ 特定

### 12.1 RAII 测试

**审查要点**:
- [ ] 构造函数是否获取资源
- [ ] 析构函数是否释放资源
- [ ] 异常安全是否保证

---

### 12.2 移动语义测试

**审查要点**:
- [ ] 移动构造函数是否被测试
- [ ] 移动赋值运算符是否被测试
- [ ] 移动后对象状态是否正确

---

### 12.3 右值引用测试

**审查要点**:
- [ ] 右值引用参数是否被测试
- [ ] std::move 是否被正确使用
- [ ] std::forward 是否被正确使用

---

## 维度 13: C 特定

### 13.1 字符串测试

**审查要点**:
- [ ] 字符串终止符是否被测试
- [ ] 缓冲区溢出是否被测试
- [ ] 字符串长度是否被验证

---

### 13.2 数组测试

**审查要点**:
- [ ] 数组边界是否被测试
- [ ] 数组越界是否被测试
- [ ] 数组初始化是否被测试

---

## 质量评估矩阵

| 维度 | 权重 | 评估标准 | 评分 (1-5) |
|-----|------|---------|-----------|
| 测试结构 | 10% | 组织规范、命名清晰 | |
| 测试覆盖 | 25% | 快乐/边界/错误场景完整 | |
| 断言使用 | 10% | 正确使用、消息清晰 | |
| Mock 使用 | 15% | 正确创建、验证、合理 | |
| 测试隔离 | 10% | 独立无依赖 | |
| 内存管理 | 15% | 无泄漏、无溢出 | |
| 并发测试 | 10% | 竞态检测、同步原语 | |
| 覆盖率 | 10% | ≥80% | |
| 可维护性 | 5% | 代码清晰、高效 | |

**总分**: ___ / 5

---

## 审查结果汇总模板

```markdown
# C/C++ 测试质量审查报告

## 审查概述
- 编程语言: C / C++
- 测试框架: Google Test / Catch2
- 审查时间: YYYY-MM-DD HH:MM
- 审查测试文件: X个
- 审查测试用例: Y个

## 审查框架
基于 `templates/testing/testing-checklist-c-cpp.md` 提供的审查维度：
1. 测试结构 (组织、命名)
2. 测试覆盖 (快乐路径、边界条件、错误场景)
3. Google Test 特性 (断言、固件、参数化)
4. Catch2 特性 (BDD 风格、Matcher、固件)
5. Mock 使用 (gMock、合理性)
6. 内存管理测试 (泄漏、溢出、智能指针)
7. 测试隔离 (独立性、文件系统隔离)
8. 并发测试 (线程安全、同步原语)
9. 覆盖率 (目标、配置)
10. 异常测试 (抛出、异常安全)
11. 模板测试 (实例化、概念约束)
12. C++ 特定 (RAII、移动语义、右值引用)
13. C 特定 (字符串、数组)

## 各维度深度审查

### 1. 测试结构维度
**分析结果**: ___
**问题列表**: ___
**改进建议**: ___

### 2. 测试覆盖维度
**分析结果**: ___
... [其他维度]

## 覆盖率分析
- 语句覆盖率: XX%
- 分支覆盖率: XX%
- 内存泄漏: 未检测到 / 检测到
- 数据竞争: 未检测到 / 检测到

## 总体评估与优先级
- 质量等级: ___
- 总分: X.X / 5.0
- 高优先级问题: [列表]
- 中优先级问题: [列表]
- 低优先级问题: [列表]

## 改进计划
1. [ ] [具体行动项]
2. [ ] [具体行动项]
3. [ ] [具体行动项]
```
