# C&C++ 编码规范检查清单

> 本文档来自「编码checklist.xls」的「C&C++」Tab页

---

## Checklist 检查项

### 说明

- 本 Checklist 需走正常流程审查
- C&C++（所有 C、C++ 代码均需遵守本规范）

---

## 检查项目

### 1. Format - 排版

#### 1.0 Overall - 总则

**原则**：统一清晰的排版可以帮助代码阅读者迅速聚焦代码的关键逻辑，迅速定位区块的开始结束位置，大大提高代码阅读的效率。

**要求**：
1. 排版风格在同一文件中，必须保持统一
2. 尽量把关系密切的逻辑集中在一起，保证视线无需漂移即可浏览到整个逻辑单元
3. 在尚未养成习惯之前，可采用 astyle 之类的工具软件格式化代码

**说明**：本条款为阐述、建议性条款

---

#### 1.1 Indent - 缩进

**要求**：程序块要采用统一的缩进和对齐风格编写。整个项目中或者是 4 个空格，或者是一个 TAB。不允许混用这两种。

**详细规定**：
- 如果是使用 TAB，需保证 TAB 键的宽度是 4 个空格
- 如果是在原有代码上修改（如 Linux 内核代码），需和原有代码的缩进、对齐方式保持一致
- 建议在编辑器设置中将 TAB 键宽度设置为 4，建议统一使用空格进行对齐

**1) 缩进要求**：
- (A) if、else、case、for、while 语句需要缩进
- (B) case 语句与所属的 switch 语句对齐
- (C) 所有 `{}` 需要缩进，`extern "C"`、`namespace` 块除外，case 语句除外

**2) 空格使用**：
- (A) 关键字 if、else、switch、case、for、while 之后要加空格
- (B) 如果 `,`、`;` 后面没有立即换行，即后面有变量或语句时，要在后面加空格
- (C) 小括号内侧不能有空格，函数调用（或宏）的名字与括号之间不能有空格
- (D) 一元操作符 `&`、`*`、`+`、`-`、`~`、`!`、`++`、`--` 要紧贴对应的变量，不能有空格
- (E) 二元操作符 `=`、`+`、`-`、`*`、`/`、`%`、`&`、`|`、`^`、`==`、`!=`、`>=`、`<=`、`>`、`<`、`?`、`:` 两侧要加空格
- (F) 结构体成员操作符 `.`、`->` 前后不加空格

**参考文档**：缩进和空格请参考范例文档 `checklist_indent_samples.html`

---

#### 1.2 Statement - 语句行

**要求**：一行只写一条语句，不允许把多个短语句写在一行中

---

#### 1.3 Parentheses - 大括号

**要求**：

1. **`}` 必须独占一行**，有两种例外：
   - A. 如果是在 `if(...){}else if(...){}else{}` 中，可与 else 放同一行
   - B. 如果是在 `do{}while(...)` 中，可与 while 放同一行

2. **`{` 可以独占一行**，且与上一语句的起始位置对齐。也可以跟在相应的 if、for、do、while、switch、class 声明、函数声明后面

3. **`{`、`}` 的相对位置在整个模块中必须保持一致**：
   - if、for、do、while、switch 这几种语句块的 `{` 必须保持相对位置一致
   - 其他语句块的 `{` 只要求在同类型之间保持相对位置一致即可

---

#### 1.4 Column - 代码行长度

**要求**：每行代码不应超过 80 列，如果某些行需要超出 80 列（比如函数参数列表，虽然不提倡定义过长参数列表，但有时候确实需要这么长），应该折成多行显示。

**例外条款**：
- A) 注释可以例外
- B) 如果字符串单独占一行仍超出 80 列，可以例外

---

### 2. Comment - 注释

#### 2.0 Overall - 总则

**目的**：注释的目的是提升代码可读性，帮助代码读者更快速的了解代码作者的实际意图。

**原则**：
1. 注释应重点阐述目的，而非过程
2. 注释应重点阐述隐性知识，即代码无法直接反映的意图、原则（如扩展方法、锁策略、内存分配限制等）
3. 注释应重点阐述模块/函数之间的关联知识，即对比分析多个函数才能得到的知识
4. 注释应避免描述显而易见的知识（如："这是一个构造函数"、"定义一个整型变量"）
5. 注释内容需要和代码实际行为保持一致，不应涉及无关内容
6. 注释需要及时更新，反映代码当前的状态

**说明**：本条款为阐述、建议性条款

---

#### 2.1 Declaration - 声明注释

**要求**：

1. **文件头**：在头文件（`*.h`、`*.hpp`、`*.inc` 等）和源文件头部应注释说明其功能
2. **函数头**：函数头部应注释说明其功能及各参数、返回值的含义（无参构造函数、析构函数、重载的运算符函数可无需注释）
3. **全局变量**：全局变量应注释说明其功能
4. **常量**：所有常量定义都应注释说明其功能
5. **类型**：所有类型定义（包括 struct、class、enum、union），都应注释说明其功能
6. **宏定义**：所有宏定义应注释说明其功能，如果宏有参数，必须说明参数的用法

**注释标准**：采用 doxygen 的注释标准，方便根据注释直接生成说明文档。

**参考文档**：范例请参考 `checklist_comment_samples.html`

---

#### 2.2 Statement - 语句注释

**要求**：在下述控制结构处应按要求进行注释。语句块少于 5 行允许例外。

1. if 语句的各个分支，注释说明条件和具体功能
2. for/while/do 的头部，注释说明循环条件和具体功能
3. switch 头部，注释说明判断条件和具体功能

**参考文档**：范例请参考 `checklist_comment_samples.html`

---

#### 2.3 Trash - 废弃代码

**要求**：确定不使用的功能代码要删除，或通过注释或者 `#if 0` 关闭

**原因**：防止未经测试的功能被意外激活或者干扰其它正常逻辑

---

### 3. Label - 标识符声明

#### 3.0 Overall - 总则

**目的**：标识符声明的终极目的是达到"代码即文档"的效果。所谓"代码即文档"，即由代码本身清晰的反映出作者的意图。

**原则**：
1. 标识符的命名应反映目的，而非过程
2. 作用域越大，影响逻辑越多的标识符，其取名越完整。作用域越小、影响面越小的标识符，其取名越简练（如循环变量可使用无特殊含义的单字符 i 进行命名）
3. 标识符的命名规则应当统一

**说明**：本条款为阐述、建议性条款

---

#### 3.1 Style - 命名风格

**要求**：命名风格在同一模块中统一。有三种风格可供选择：

1. **Unix 风格**：全小写，单词间用下划线分隔（如：`max_user_count`）
2. **Windows 风格**：驼峰命名法，小写开头（如：`maxUserCount`）
3. **匈牙利命名法**：前缀 + 类型 + 含义（不推荐新代码使用）

**注意**：无论选择哪种风格，在整个模块中必须保持一致

---

#### 3.2 Meaning - 含义

**要求**：标识符应当能够准确描述其代表的实体

1. 变量名应当描述变量的用途
2. 函数名应当是一个动词短语，描述函数的功能
3. 类型名应当是一个名词，描述类型的抽象概念
4. 常量名应当全大写，单词间用下划线分隔

---

#### 3.3 Scope - 作用域

**要求**：尽可能缩小标识符的作用域

1. 优先使用局部变量而非全局变量
2. 使用 C++ 的命名空间来避免全局命名空间污染
3. 类的成员变量应当尽可能设为 private，通过 public/protected 方法访问

---

#### 3.4 Hungarian - 匈牙利命名法

**说明**：匈牙利命名法在现代 C++ 开发中已不再推荐使用

**原因**：
1. 现代IDE可以显示变量类型
2. 类型安全由编译器保证
3. 增加代码维护难度

**例外**：如果项目已有代码使用匈牙利命名法，为保持一致性，新代码也应当遵循

---

### 4. Variable - 变量声明

#### 4.1 Declaration - 声明位置

**要求**：

1. **C 语言**：变量应当在函数开始处集中声明
2. **C++ 语言**：变量应当尽可能在首次使用时声明
3. **循环变量**：尽可能在 for 语句中声明

---

#### 4.2 Initialization - 初始化

**要求**：

1. 所有变量在使用前必须初始化
2. 指针变量声明时应当初始化为 `nullptr` 或 `NULL`
3. 引用变量必须在声明时初始化
4. 数组应当使用 `{}` 初始化

---

### 5. Function - 函数设计

#### 5.1 Length - 函数长度

**要求**：

1. 单个函数的代码行数一般不超过 80 行
2. 函数应当只做一件事，并做好这件事
3. 如果函数过长，考虑拆分为多个小函数

---

#### 5.2 Parameters - 参数数量

**要求**：

1. 函数参数一般不超过 5 个
2. 参数过多时，考虑使用结构体封装相关参数
3. 使用引用或指针传递大型对象，避免拷贝

---

#### 5.3 Return - 返回值

**要求**：

1. 函数应当有明确的返回值
2. 使用返回值表示函数执行状态
3. 避免使用输出参数传递主要结果

---

### 6. Memory - 内存管理

#### 6.1 Allocation - 内存分配

**要求**：

1. 优先使用智能指针（`std::unique_ptr`、`std::shared_ptr`）
2. 避免直接使用 `new`/`delete`
3. 使用标准容器（`std::vector`、`std::string`）代替动态数组

---

#### 6.2 Leak - 内存泄漏

**要求**：

1. 每次 `new` 必须有对应的 `delete`
2. 使用 RAII（Resource Acquisition Is Initialization）原则管理资源
3. 使用工具检测内存泄漏（如 Valgrind、AddressSanitizer）

---

### 7. Exception - 异常处理

#### 7.1 Usage - 异常使用

**要求**：

1. 使用异常处理错误情况，不用于正常控制流
2. 异常应当值传递，不要抛出指针
3. 捕获异常时按引用捕获

---

#### 7.2 Resource - 资源清理

**要求**：

1. 使用 RAII 确保资源正确释放
2. 析构函数不应当抛出异常
3. 使用 `try-catch` 块时确保资源正确释放

---

### 8. Thread - 线程安全

#### 8.1 Synchronization - 同步

**要求**：

1. 共享数据的访问必须同步
2. 使用互斥锁（`std::mutex`）保护共享数据
3. 避免死锁：按固定顺序获取多个锁

---

#### 8.2 Atomic - 原子操作

**要求**：

1. 简单变量使用 `std::atomic` 而非锁
2. 理解内存序（memory ordering）的含义
3. 避免使用全局变量作为线程间通信手段

---

### 9. Const - 常量性

#### 9.1 ConstCorrectness - const 正确性

**要求**：

1. 不修改对象的成员函数应当声明为 `const`
2. 不修改的参数应当声明为 `const` 引用或指针
3. 优先使用 `const` 变量而非 `#define`

---

#### 9.2 Constexpr - 编译时常量

**要求**：

1. 编译期常量使用 `constexpr` 而非 `const`
2. 使用 `constexpr` 函数计算编译期常量
3. `constexpr` 变量默认为内联

---

### 10. Template - 模板使用

#### 10.1 Usage - 模板使用

**要求**：

1. 模板应当简洁明了，避免过度复杂的模板元编程
2. 模板代码应当在头文件中定义
3. 使用 `static_assert` 在编译期检查模板参数

---

#### 10.2 Specialization - 特化

**要求**：

1. 优先使用函数重载而非模板特化
2. 类型特征（type traits）使用标准库提供的 `std::enable_if` 或 C++17 的 `if constexpr`
3. 避免部分特化带来的代码膨胀

---

## 检查表格

| 序号 | 检查项 | 是否通过 | 未通过/免检说明 | 问题跟踪 | 备注 |
|-----|-------|---------|--------------|---------|------|
| 1.0 | Format - Overall - 总则 | | | | 建议性条款 |
| 1.1 | Format - Indent - 缩进 | | | | |
| 1.2 | Format - Statement - 语句行 | | | | |
| 1.3 | Format - Parentheses - 大括号 | | | | |
| 1.4 | Format - Column - 代码行长度 | | | | |
| 2.0 | Comment - Overall - 总则 | | | | 建议性条款 |
| 2.1 | Comment - Declaration - 声明注释 | | | | |
| 2.2 | Comment - Statement - 语句注释 | | | | |
| 2.3 | Comment - Trash - 废弃代码 | | | | |
| 3.0 | Label - Overall - 总则 | | | | 建议性条款 |
| 3.1 | Label - Style - 命名风格 | | | | |
| 3.2 | Label - Meaning - 含义 | | | | |
| 3.3 | Label - Scope - 作用域 | | | | |
| 3.4 | Label - Hungarian - 匈牙利命名法 | | | | 不推荐 |
| 4.1 | Variable - Declaration - 声明位置 | | | | |
| 4.2 | Variable - Initialization - 初始化 | | | | |
| 5.1 | Function - Length - 函数长度 | | | | |
| 5.2 | Function - Parameters - 参数数量 | | | | |
| 5.3 | Function - Return - 返回值 | | | | |
| 6.1 | Memory - Allocation - 内存分配 | | | | |
| 6.2 | Memory - Leak - 内存泄漏 | | | | |
| 7.1 | Exception - Usage - 异常使用 | | | | |
| 7.2 | Exception - Resource - 资源清理 | | | | |
| 8.1 | Thread - Synchronization - 同步 | | | | |
| 8.2 | Thread - Atomic - 原子操作 | | | | |
| 9.1 | Const - ConstCorrectness - const 正确性 | | | | |
| 9.2 | Const - Constexpr - 编译时常量 | | | | |
| 10.1 | Template - Usage - 模板使用 | | | | |
| 10.2 | Template - Specialization - 特化 | | | | |

---

## 审核结果

| 项目 | 结果 |
|-----|------|
| **自检人** | |
| **自检日期** | |
| **审核人** | |
| **审核日期** | |
| **通过率** | |
| **总体评价** | |
