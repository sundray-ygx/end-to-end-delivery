# XXX模块详细设计说明书 v3.6

[公司名称]

## 修订记录

| 修订版本号 | 作者 | 日期 | 简要说明 |
|---------|------|------|---------|
| V3.6 | [作者] | [日期] | [简要说明] |

---

## 目录

- [1 介绍](#1-介绍)
  - [1.1 目的](#11-目的)
  - [1.2 定义和缩写](#12-定义和缩写)
  - [1.3 参考和引用](#13-参考和引用)
- [2 设计任务书](#2-设计任务书)
  - [2.1 需求跟踪](#21-需求跟踪)
  - [2.2 模块整体目标](#22-模块整体目标)
  - [2.3 流程要求](#23-流程要求)
- [3 对外接口](#3-对外接口)
  - [3.1 API接口](#31-api接口)
  - [3.2 消息接口](#32-消息接口)
- [4 概要说明](#4-概要说明)
  - [4.1 背景描述](#41-背景描述)
  - [4.2 方案选型](#42-方案选型)
  - [4.3 静态结构](#43-静态结构)
  - [4.4 对软件总体架构的影响](#44-对软件总体架构的影响)
  - [4.5 概要流程](#45-概要流程)
  - [4.6 方案风险分析](#46-方案风险分析)
- [5 数据结构设计](#5-数据结构设计)
  - [5.1 配置文件定义](#51-配置文件定义)
  - [5.2 全局数据结构定义](#52-全局数据结构定义)
- [6 流程设计](#6-流程设计)
  - [6.1 子模块1/类1/主题1](#61-子模块1类1主题1)
  - [6.2 子模块2/类2/主题2](#62-子模块2类2主题2)
- [7 总结](#7-总结)
  - [7.1 关联分析](#71-关联分析)
  - [7.2 遗留问题解决](#72-遗留问题解决)
- [8 业务逻辑相关的测试用例](#8-业务逻辑相关的测试用例)
- [9 变更控制](#9-变更控制)
  - [9.1 变更列表](#91-变更列表)

---

# 1 介绍

## 1.1 目的

*简要介绍设计或修改该模块的目的，说明书要描述和解决的主要问题，和使用该规格书的对象(及各对象需要关注的内容等)。*

## 1.2 定义和缩写

*定义或解释本文档中使用的所有专用名词和缩略语。*

## 1.3 参考和引用

*列出本文档编写过程中参考的其它文档或资料*

1. *参考需求文档的哪些章节*
2. *参考总体设计文档的哪些章节*
3. *参考的其他文档*

---

# 2 设计任务书

*本设计目标书在设计开始前由总体设计人员填写下发给概要设计人员，责任追溯时，如果任务书不完整有遗漏，则为总体设计人员的责任。*

*概要设计人员遵照任务书要求完成设计，需自行检查是否达到任务书的要求，在"自检"这一列填写是否通过（如对于需求点，需指明相关描述所在的章节号）。*

*性能目标和整体目标不允许写"与XX相同"一类，如果与别的项目（或版本）相同，就把别的项目（或版本）的指标复制到这里。*

## 2.1 需求跟踪

> **需求跟踪（必须覆盖需求矩阵中与本模块相关的所有需求点）**

| 编号 | 需求点名称 | 需求点说明/验收条件 | 自检 |
|-----|-----------|-------------------|------|
| 1.1 | *（有多个功能点，就依次COPY，实际编写需求列表时请把注释和例子删除）* | *从功能要求（能完成什么任务，达成用户什么期望），性能要求（包括资源开销），稳定可靠性要求等方面描述该需求点完成后需要达成的要求。本描述要求简洁、准确，可作为设计验收的checklist。* | *写明该需求点具体在哪个章节描述* |
| 1.2 | *例子（AC上网加速中的需求点）：能够启用、禁用整个上网加速系统；* | 1.用户可以启用或禁用上网加速，启用时能够提升内网用户的上网速度，禁用时对系统性能无任何影响；<br>2.启动系统时间不超过3.5s，禁用系统不超过3s<br>3.异常关机、配置文件被破坏情况下仍能正常启动系统； | 通过，见6.1.2 |

## 2.2 模块整体目标

| 编号 | 目标项概述 | 对应的评审标准 | 自检 |
|-----|-----------|---------------|------|
| 2.1 | 性能 | 并发用户数<br>并发连接数<br>PPS（每秒处理包个数）<br>支持规则数<br>界面响应速度<br>新建连接速度<br>其它 | |
| 2.2 | 资源开销 | 内存占用<br>DISK占用<br>其它 | |
| 2.3 | 安全性要求 | 防止被越权使用或者成为攻击点 | |
| 2.4 | 可靠性要求 | 本业务模块的可靠性要求（也即可靠性能力目标） | *定义本模块的可靠性性能目标（目标要可验证可衡量）* |
| 2.5 | 可测试性要求 | 可测试性目标或需求 | |
| 2.6 | 可调试性要求 | 可调试性目标或需求 | |
| 2.7 | 可运维性要求 | 可运维性目标或需求 | |
| 2.8 | 可扩展性要求 | 可扩展性目标或需求 | |
| 2.9 | 可复用性要求 | 可复用性目标或需求 | |
| 2.10 | 兼容性 | 允许升级配置的版本<br>允许对接的版本 | |
| 2.11 | 其它 | | |

## 2.3 流程要求

| 项目 | 内容 |
|-----|------|
| 该文档是否需要外部评审？ | *按设计流程要求* |
| 审核人签名 | 　 |
| 时间 | 　 |

---

# 3 对外接口

*描述本模块对外提供的软件接口，即是该模块的需要实现的需求功能之一*

*需要提供哪些对外接口，是从总体设计里面分解模块得到的，这里可以拷贝总体里面该模块的外部接口列表。*

*如果本模块支持自动化测试，需要实现对应的自动化测试接口，也需在"对外接口"中明确下来。*

*模块的对外接口，需要遵守公司定义的API规范。如果现有规范无法覆盖需求，需要组织干系方讨论需求，提取新的规范接口并评审。*

## 3.1 API接口

*如果未对外提供API接口，本章节可以忽略。*

*Api接口：以api或rpc等形式提供的外部接口。*

*如果是产品级对外的openAPI，或者产品之间的openAPI，统一使用swagger格式归档。*

*如果模块之间的API，不强约束。可以采用如下表格。*

| 名称 | create\_listener |
|-----|------------------|
| 功能 | *创建侦听socket* |
| 参数 | | 参数名 | 类型 | 方向 | 说明 |
| | |-----|------|------|------|
| | | *port* | *int* | *in* | *Socket侦听的端口* |
| | | *... ...* | | | |
| 返回值 | *Socket的描述符* |

## 3.2 消息接口

*如果未对外提供消息接口，本章节可以忽略。*

*消息接口：以进程/实体间传递的消息为接口*

| 名称 | *msg\_hdr* |
|-----|-----------|
| 说明 | *该二进制消息的用途，注意事项等* |
| 字段 | | 字段名 | 类型/长度(单位bit) | 说明 |
| | |-----|-----------------|------|
| | | *head* | *CH* | *通用数据头* |
| | | *src\_ip* | *32* | *源IP* |
| | | *dst\_ip* | *32* | *目的虚拟IP* |
| | | *src\_port* | *16* | *源端口* |
| | | *dst\_port* | *16* | *目的端口* |
| | | *buff* | *变长* | *载荷* |

---

# 4 概要说明

## 4.1 背景描述

### 工作原理

> *描述本模块的主要工作原理，关键需求的设计思路。*

### 应用场景

*对本模块在客户处的应用场景进行分析。客户应用本模块解决什么问题，客户在哪些场合、有哪些方式来应用本模块，使用过程中有哪些操作，会发生哪些事件，需要得到什么处理结果？*

*场景分析的目的是分析清楚模块运行过程中会发生什么事件，分析的结果用以评估各方案在实际运行过程中，能否正常应对这些事件，会不会发生问题。*

### 对手分析

*如果竞争对手有类似功能，本节对竞争对手的功能实现进行分析，说明对手的方案的优缺点，以及借鉴的地方。如果业界其它产品中有类似功能或方案，选择较为突出的进行分析，并说明借鉴的地方。对手分析的目的不是模仿对手，而是为了更全面的了解该领域需要面对的问题和前人已经使用过的解决方案，保证设计过程不要踩坑，做无用功。*

## 4.2 方案选型

*此章节，需要使用方案选型表对核心需求项的多个可行方案进行选型，确定最终采用的实现方案。*

*此处简述本设计的可供选型方案，并说明最终所选的方案，以及选择该方案的原因。*

| 评估准则 | 权重 | 评估方法 | 方案1 | | 方案2 | | 方案3 | | 方案4 | |
|---------|------|---------|-------|---|-------|---|-------|---|-------|---|
| | | | 打分 | 加权得分 | 打分 | 加权得分 | 打分 | 加权得分 | 打分 | 加权得分 |
| *评估准则1* | 50% | | 5 | 2.5 | | 0 | | 0 | | 0 |
| *评估准则2* | 15% | | 5 | 0.75 | | 0 | | 0 | | 0 |
| *评估准则3* | 20% | | 5 | 1 | | 0 | | 0 | | 0 |
| *评估准则4* | 15% | | 5 | 0.75 | | 0 | | 0 | | 0 |
| | | | | 0 | | 0 | | 0 | | 0 |
| **最终得分（满分为5分）** | | | 5.00 | | 0.00 | | 0.00 | | 0.00 |

| 备选方案名称 | 本方案的优点 | 本方案的风险和缺点 | 最终选择 |
|-------------|-------------|-------------------|---------|
| *方案1* | | | |
| *方案2* | | | |
| *方案3* | | | |
| *方案4* | | | |

## 4.3 静态结构

*本章节描述模块中各软件单元（子模块或类）之间的结构关系，使用静态视图方式描述（比如类图、结构图等）。即整个模块可以分解为哪些软件单元，这些软件单元相互之间是什么关系，以及他们是怎么协作完成整体工作任务的。*

*本章节还需描述那些作为流程间协作纽带的公共数据结构，比如连接跟踪模块的连接表。本章对数据结构进行概要描述，主要描述数据结构设计意图以及与其它数据结构之间的关系，帮助理解围绕该数据结构设计的概要流程。详细定义可以放在后续章节给出。*

## 4.4 对软件总体架构的影响

*本章节描述本次新增及调整模块对软件总体架构的影响点。*

## 4.5 概要流程

说明本模块的基本设计概念和处理流程动态视图，尽量使用图表的形式，并描述其具体步骤。本节描述的流程一般是那些涉及到多个子模块(或类)的流程。

### 流程1(改成具体的流程名字)

> *描述。*

### 流程x(根据需要可自行添加章节)

> *描述。*

## 4.6 方案风险分析

*对本章描述的方案进行整体风险分析，找到所有可能存在风险的关键环节，对每一个风险，需要给出解决方法（包括消除、规避、缓解、后续跟进等）。对于现阶段无法消除的风险，需要整理为列表，作为后续跟进的事项。*

*对于有风险没有把握的设计，需要有预研结果做保证或者有备用方案。万一此路不通，可以选择备用方案。*

| 风险点 | 风险预研结果/风险规避措施 |
|-------|------------------------|
| 例1：处理速度达100MBPS | 根据预研文档《xxx》，可以达到要求 |
| 例2：缓存数据耗用内存可能超过800M | 如果超过800M，使用最久未使用淘汰算法将部分数据保存在磁盘上。 |

---

# 5 数据结构设计

## 5.1 配置文件定义

> *定义相应的配置文件格式，存储方式，存储路径，各字段代表什么意义。如果是存储在数据库中，需说明数据库名，表名。*

| 名称 | 作用 | 默认值 | 取值范围 |
|-----|------|-------|---------|
| *max\_username* | *最大的用户名字长度* | *256* | *字符串，长度范围\[16,1024)* |
| *log\_fname* | *日志文件名* | */var/log/ac.txt* | *文件路径名，合法的linux文件名* |

> *如果需要在原有配置文件基础上升级，需描述配置的升级流程。*

## 5.2 全局数据结构定义

*描述全局数据结构设计，须描述每一个字段的名称和作用。全局数据结构包括：*

1. *在多个软件单元之间传递（比如通过函数参数）的数据结构；*
2. *全局变量；*
3. *通讯用的消息；*

| 结构说明 | *IP组，存放一组服务器的IP* |
|---------|--------------------------|
| 结构定义 | *struct ip\_group{*<br>*size\_t cnt;*<br>*unsigned int ips\[0\];*<br>*};* |
| **字段说明** | **字段名** | **取值范围** | **说明** |
| | *cnt* | *\[0,4K\]* | *ips数组的长度，即里面存放的整数个数* |
| | *ips* | *网络字节序的IP地址数组，数组长度为cnt指定长度* | *IP地址数组* |

---

# 6 流程设计

描述模块内部各软件单元的组织结构，接口，以及逻辑，算法实现等。这里指的软件单元可以是一个子模块，也可以是C++的一个类。

## 6.1 子模块1/类1/主题1

### 静态结构

*描述本子模块的职责定义，以及本子模块由哪些更细化的软件单元组成。*

### 处理流程

*描述子模块内部各函数之间的交互逻辑。*

### 关键算法描述

*分析本子模块中哪些算法流程是关键流程，会影响到模块整体的关键性能。有性能（或效果）要求的算法必须在此阐述。每个算法须描述最常见的场景及性能最差的场景，并说明在这两个场景下可达到的性能指标。如果最差场景不能达到性能要求，需分析该场景在用户处出现的几率，以及出现该场景对用户造成的负面影响。*

### 数据结构定义

*描述函数间传递的数据结构或者进程/实体间传递的消息。*

### 函数列表

*描述本模块中需要实现的函数。对于每个函数，需要描述函数的名字，函数功能，参数的类型和作用、取值范围，返回值的类型和作用、取值范围，以及该函数的其它前后置约束条件（比如需要访问的全局变量）。*

| 函数名 | 函数功能 | 参数及返回值 | 说明（包括其它前置/后置约束条件，等） |
|-------|---------|------------|-------------------------------|
| *generate* | *生成测试案例* | *\[in\]const value\_t\* val：输入模板，必须为有效的value\_t；*<br>*\[out\]vector<value\_t\*\>* ptests：保存输出的案例，调用者负责释放。约束条件：ptests && ptests-\>size() == 0* | |

### 设计要点检视

*本表格作为一个设计要点的检查列表，帮助设计人员回顾相关要点具体是怎么考虑的，是否已经满足需要。相关要点必须体现在本章的各个子章节中（比如结构、流程、函数列表等），表格填写内容仅仅作为一个总结。*

| 可维护/可调试措施 | *分析开发过程可能遇到的调试难题，描述设计中所提供的解决方案。需要说明针对这些调试难题，给开发调试、维护人员具体提供了哪些排错手段。怎么帮助开发、维护人员更快定位，排除错误。* |
|-----------------|-----------------------------------------------------------------------------------|
| 可测试性 | *分析测试过程可能遇到的测试难题，描述设计中所提供的解决方案。需要说明针对这些测试难题，给测试人员提供了哪些测试支持。怎么保证更易于测试本模块。* |
| 自动化测试支持 | *分析该子模块如何进行自动化测试，怎么保证自动化测试能够更好验证本子模块/类的功能。* |
| 可扩展性 | *分析将来版本最有可能发生扩展的特性，说明针对这些扩展保留的设计支持；* |
| 稳定性保证措施 | *分析软件运行过程中，该子模块容易发生哪些类型异常，给出异常检测，异常恢复措施* |
| 工作量估算 | *对实现本节设计内容需要的工作量进行估算，按人天算。设计需要消除风险，让风险可控。风险可控的典型标志就是可以较为准确的估算出工作量* |

## 6.2 子模块2/类2/主题2

*按上面格式模板描述下一个子模块或者类*

---

# 7 总结

## 7.1 关联分析

对老模板/老版本/相关联产品的影响，请做分析。可以和对应的模块责任人架构师做交流

## 7.2 遗留问题解决

说明在总体设计过程中尚未解决的各个问题的解决方案。

说明在上一个版本未解决的应该在本模块中解决的各个遗留问题的解决方案；

---

# 8 业务逻辑相关的测试用例

此部分内容在详细设计模板中也有。如果一个模块概设、详设都做，此章节在其中一个文档中完成即可。

设计完成后，鉴于测试人员可能对模块设计的内部逻辑、流程、数据流向不清楚，用例质量会得不到保证。

为了提高测试用例的质量，尽早尽全地覆盖到关键实现，要求开发人员撰写内部逻辑、流程、数据流向相关的测试用例。

如果对测试用例的设计不太清楚，至少要描述出测试步骤和验证点。

此部分可以放到编码结束后补充填写。

如果给测试人员讲的很清楚，测试版本经理认为不用写，可以不写。

---

# 9 变更控制

## 9.1 变更列表

*在编码过程中，可能会有一些设计不合理的地方，需要对原设计做一些调整，需要在这里说明变更的章节、内容、原因，并对变更进行评审确认（至少需要经过版本经理/开发经理的确认）。此章节在编码完对设计文档更新后进行评审确认。*

*需求变更引起的设计变更，也在下面加以说明，并对设计变更的结果进行部门内部评审。*

| 变更章节 | 变更内容 | 变更原因 | 变更对对老功能、原有设计的影响 |
|---------|---------|---------|-------------------------------|
|         |         |         | 考虑完全这些影响，要和开发经理、架构师、设计人员、老版本的开发人员进行交流，并最后评审。 |
